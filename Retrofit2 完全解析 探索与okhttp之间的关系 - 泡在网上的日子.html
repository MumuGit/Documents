<!DOCTYPE html>
<!-- saved from url=(0073)http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html -->
<html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html; charset=GBK"><script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/shares.php" charset="utf-8"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子</title>
<meta name="keywords" content="Retrofit">
<meta name="description" content="原文出处： http://blog.csdn.net/lmj623565791/article/details/51304204 一、概述 之前写了个okhttputils的工具类，然后有很多同学询问这个工具类和 retrofit 什么区别，于是上了下官网，发现其底层对网络的访问默认也是基于 okhttp ，不过 retrofit 非常">
<link href="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/new.css" rel="stylesheet" type="text/css">
<script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/ca-pub-8583773779396897.js.下载"></script><script language="javascript" type="text/javascript" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/jquery-1.7.1.min.js.下载"></script>
<link href="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/tranquil-heart.min.css" rel="stylesheet">
<script language="javascript" type="text/javascript" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myajax.js.下载"></script>
<script language="javascript" type="text/javascript">
	function CheckLogin(){
	    var taget_obj = document.getElementById('login_info');
	    myajax = new MyAjax(taget_obj,false,false,'','','');
	    myajax.SendGet2("/member/ajax_loginsta.php");
	    DedeXHTTP = null;
	}
	function checkSubmit(){
		if(document.feedback.msg.value!='') document.feedback.submit();
		else alert("评论内容不能为空！");
	}		

	function postBadGood(ftype,fid)
	{
		var taget_obj = document.getElementById(ftype+fid);
		var saveid = GetCookie('badgoodid');
		if(saveid != null)
		{
			var saveids = saveid.split(',');
			var hasid = false;
			saveid = '';
			j = 1;
			for(i=saveids.length-1;i>=0;i--)
			{
				if(saveids[i]==fid && hasid) continue;
				else {
					if(saveids[i]==fid && !hasid) hasid = true;
					saveid += (saveid=='' ? saveids[i] : ','+saveids[i]);
					j++;
					if(j==10 && hasid) break;
					if(j==9 && !hasid) break;
				}
			}
			if(hasid) { alert('您刚才已表决过了喔！'); return false;}
			else saveid += ','+fid;
			SetCookie('badgoodid',saveid,1);
		}
		else
		{
			SetCookie('badgoodid',fid,1);
		}
		myajax = new MyAjax(taget_obj,false,false,'','','');
		myajax.SendGet2("/plus/feedback.php?aid="+fid+"&action="+ftype+"&fid="+fid);
	}
	function postStow(aid)
	{
		var taget_obj = document.getElementById('newdigg');
 
		myajax = new MyAjax(taget_obj,false,false,'','','');
		myajax.SendGet2("/plus/stow.php?aid="+aid);
	}
	function postDigg(ftype,aid)
	{
		var taget_obj = document.getElementById('newdigg');
		var saveid = GetCookie('diggid');
		if(saveid != null)
		{
			var saveids = saveid.split(',');
			var hasid = false;
			saveid = '';
			j = 1;
			for(i=saveids.length-1;i>=0;i--)
			{
				if(saveids[i]==aid && hasid) continue;
				else {
					if(saveids[i]==aid && !hasid) hasid = true;
					saveid += (saveid=='' ? saveids[i] : ','+saveids[i]);
					j++;
					if(j==20 && hasid) break;
					if(j==19 && !hasid) break;
				}
			}
			if(hasid) { alert("您已经顶过该帖，请不要重复顶帖 ！"); return; }
			else saveid += ','+aid;
			SetCookie('diggid',saveid,1);
		}
		else
		{
			SetCookie('diggid',aid,1);
		}
		myajax = new MyAjax(taget_obj,false,false,'','','');
		var url = "/plus/digg_ajax.php?action="+ftype+"&id="+aid;
		myajax.SendGet2(url);
	}
	function getDigg(aid)
	{
		var taget_obj = document.getElementById('newdigg');
		myajax = new MyAjax(taget_obj,false,false,'','','');
		myajax.SendGet2("/plus/digg_ajax.php?id="+aid);
		DedeXHTTP = null;
	} 
	function getcollectionuser(aid)
	{
		var taget_obj = document.getElementById('collection-users-list');
		myajax = new MyAjax(taget_obj,false,false,'','','');
		myajax.SendGet2("/plus/collection_user_ajax.php?id="+aid);
		DedeXHTTP = null;
	} 	
	jQuery(document).ready(function($) {
		$('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
	    prettyPrint();
	
	    //注意最后的@me必须要加两重引号，不然js语法会出错
	    var htmlstr =  '';
	    $(".arc_body").prepend(htmlstr); 
	});
			
</script>

<link rel="preload" href="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/integrator.js.下载" as="script"><script type="text/javascript" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/integrator.js.下载"></script><link rel="preload" href="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/integrator.js(1).下载" as="script"><script type="text/javascript" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/integrator.js(1).下载"></script></head>
<body><link href="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/jiathis_counter.css" rel="stylesheet" type="text/css"><link href="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/jiathis_share.css" rel="stylesheet" type="text/css"><iframe frameborder="0" style="position: absolute; display: none; opacity: 0;" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/saved_resource.html"></iframe><div class="jiathis_style" style="position: absolute; z-index: 1000000000; display: none; top: 50%; left: 50%; overflow: auto;"></div><div class="jiathis_style" style="position: absolute; z-index: 1000000000; display: none; overflow: auto;"></div><iframe frameborder="0" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/jiathis_utility.html" style="display: none;"></iframe>

<div class="header">  
	<div class="headercon container clearfix">
        <div class="row">
            <div class="col-md-12">
            	<!-- 导航部分 -->
                <a class="logo-t" href="http://www.jcodecraeer.com/"><img src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/logo.png">泡在网上的日子</a>
                <ul class="nav-ul">
                	<li id="nav-index"><a href="http://www.jcodecraeer.com/">首页</a></li>
                    <li id="nav-code"><a href="http://www.jcodecraeer.com/plus/list.php?tid=31">代码</a></li>
                    <li id="nav-feed"><a class="" href="http://www.jcodecraeer.com/plus/freelist.php?lid=12">话题</a></li>
                    <li id="nav-ask"><a class="" href="http://www.jcodecraeer.com/hao">导航</a></li>
                    <li id="nav-ask"><a class="" href="http://www.jcodecraeer.com/ask">问答</a></li>
                    <li><a href="http://www.jcodecraeer.com/about.html" class="">关于</a></li>

                </ul>
                <!-- 导航部分 end -->
                
                <!-- 搜索-下拉 -->
                <div class="header_right">
                    <a href="http://www.jcodecraeer.com/appdown.html" class="lg_app">APP</a>
                	<div class="search_start">
                         <div class="search_cont">
                            <form action="http://www.jcodecraeer.com/plus/search.php" method="get">
                            	<input type="hidden" name="kwtype" value="0">
                                <input type="text" name="q" class="in_search" autocomplete="off" value="搜索">
                                <input type="submit" class="in_submit">
        						<span class="glyphicon glyphicon-search icon-search"></span>
                            </form>
                        </div>
                    </div>
                    <!-- 消息下拉 -->
                    <div class="header_right_msg z">  
                        <!-- 登录 -->
                        <div class="right_login" id="login_info">
                            <a class="l" href="http://www.jcodecraeer.com/member/login.php">登录</a>
                            <a href="http://www.jcodecraeer.com/member/reg_new.php">注册</a>
                        </div>
                        <!-- 登录 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script language="javascript" type="text/javascript">CheckLogin();</script>
<script language="javascript" type="text/javascript">
  $(function(){
	
	$(".in_search").click(function(){
		$(".search_cont").addClass('ser').animate({
			width:200,
		},200);
		if($(this).val() == '搜索'){
			$(".in_search").val('');
		}
	})
	$(".in_search").blur(function(){
		if($(this).val() !== ''){
			return false;
		}
		$(".search_cont").removeClass('ser').animate({
			width:90,
		},200);
		$(".in_search").val('搜索');
	});
	
});
</script>


<div class="container main">
	<div class="row">	
	    <div class="text-center mgt20">	
			<script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/fuckblok.php" language="javascript"></script><script async="" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/adsbygoogle.js.下载"></script>
<!-- 超大横幅 -->
<ins class="adsbygoogle" style="display:inline-block;width:970px;height:250px" data-ad-client="ca-pub-8583773779396897" data-ad-slot="3361054319" data-adsbygoogle-status="done"><ins id="aswift_0_expand" style="display:inline-table;border:none;height:250px;margin:0;padding:0;position:relative;visibility:visible;width:970px;background-color:transparent;"><ins id="aswift_0_anchor" style="display:block;border:none;height:250px;margin:0;padding:0;position:relative;visibility:visible;width:970px;background-color:transparent;"><iframe width="970" height="250" frameborder="0" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;width:970px;height:250px;" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/saved_resource(1).html"></iframe></ins></ins></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script> 
		</div>
	</div>
	<div class="row">	
        <div class="col-md-9">
			<div class="arc_position">
				  <a href="http://www.jcodecraeer.com/">首页</a>&nbsp;&#8250;&nbsp;<a href="http://www.jcodecraeer.com/plus/list.php?tid=16">安卓开发</a>&nbsp;&#8250;&nbsp;<a href="http://www.jcodecraeer.com/plus/list.php?tid=18">android开发</a>
			</div>	
					
            <div class="articlecon clearfix">
				<h1 class="title">Retrofit2 完全解析 探索与okhttp之间的关系</h1>
			
				<div class="subinfo clearfix">              
					<span>泡在网上的日子 / 文</span>
					<span> 发表于2016-05-04 12:13</span>   
					<span>第<script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/count.php" type="text/javascript" language="javascript"></script>16837次阅读
					</span>
					<span class="tags" id="arc_tags">                            
						<a href="http://www.jcodecraeer.com/tags.php?/Retrofit/" class="tag">Retrofit</a>
					 </span>
				</div>
				<!-- JiaThis Button BEGIN -->
				<div class="jiathis_style" style=" height:30px; width:180px; margin:auto;text-align:center;">
					<a class="jiathis_button_qzone" title="分享到QQ空间"><span class="jiathis_txt jtico jtico_qzone"></span></a>
					<a class="jiathis_button_tsina" title="分享到微博"><span class="jiathis_txt jtico jtico_tsina"></span></a>
					<a class="jiathis_button_tqq" title="分享到腾讯微博"><span class="jiathis_txt jtico jtico_tqq"></span></a>
					<a class="jiathis_button_weixin" title="分享到微信"><span class="jiathis_txt jtico jtico_weixin"></span></a>
					<a class="jiathis_button_renren" title="分享到人人网"><span class="jiathis_txt jtico jtico_renren"></span></a>
					<a class="jiathis_button_xiaoyou" title="分享到朋友网"><span class="jiathis_txt jtico jtico_xiaoyou"></span></a>
					<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
					<a class="jiathis_counter_style"><span class="jiathis_button_expanded jiathis_counter jiathis_bubble_style" id="jiathis_counter_22" title="累计分享10次">10</span></a>
				</div>
				<script type="text/javascript" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/jia.js.下载" charset="utf-8"></script><script type="text/javascript" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/plugin.client.js.下载" charset="utf-8"></script>
				<!-- JiaThis Button END -->
             
				<div class="arc_body"> 
					 <p style="margin-top:10px">
						<script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/fuckblok(1).php" language="javascript"></script><strong>编辑推荐：</strong><a href="https://juejin.im/">稀土掘金</a>，这是一个针对技术开发者的一个应用，你可以在掘金上获取最新最优质的技术干货，不仅仅是Android知识、前端、后端以至于产品和设计都有涉猎，想成为全栈工程师的朋友不要错过！
					</p>
					 <p>原文出处：<a href="http://blog.csdn.net/lmj623565791/article/details/51304204" _src="http://blog.csdn.net/lmj623565791/article/details/51304204">http://blog.csdn.net/lmj623565791/article/details/51304204</a>&nbsp;</p><h2 id="一概述">一、概述</h2><p>之前写了个okhttputils的工具类，然后有很多同学询问这个工具类和<code>retrofit</code>什么区别，于是上了下官网，发现其底层对网络的访问默认也是基于<code>okhttp</code>，不过<code>retrofit</code>非常适合于<code>restful url</code>格式的请求，更多使用注解的方式提供功能。</p><p>既然这样，我们本篇博文首先研究其所提供的常用的用法：</p><ul class=" list-paddingleft-2"><li><p>一般的get、post请求</p></li><li><p>动态url，动态参数设置，各种注解的使用</p></li><li><p>上传文件（单文件，多文件上传等）</p></li><li><p>下载文件等（这个不推荐retrofit去做，具体看下文）</p></li></ul><p>此外，由于其内部提供了<code>ConverterFactory</code>用于对返回的<code>requestBody</code>进行转化和特殊的<code>requestBody</code>的构造，所以本文也包含：</p><ul class=" list-paddingleft-2"><li><p>如何自定义<code>ConverterFactory</code></p></li></ul><p>最后呢，因为其源码并不复杂，本文将对源码进行整体的介绍，即</p><ul class=" list-paddingleft-2"><li><p>retrofit 源码分析</p></li></ul><p>ok，说这么多，既然需要<code>restful url</code>，我只能捡起我那个半桶水的spring mvc 搭建一个服务端的小例子~~</p><p>最后本文使用版本：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="pln">compile&nbsp;</span><span class="str">'com.squareup.retrofit2:retrofit:2.0.2'</span></li></ol></pre><p>主要是源码解析，自定义<code>Converter.Factory</code>等一些细节的探索。</p><p>恩，写完后，发现本文很长，中途请没事站起来走两步。</p><p>retrofit2官网地址：<a href="https://github.com/square/retrofit/">https://github.com/square/retrofit/</a></p><h2 id="二retrofit-用法示例">二、retrofit 用法示例</h2><h3 id="1一般的get请求">(1)一般的get请求</h3><p><code>retrofit</code>在使用的过程中，需要定义一个接口对象，我们首先演示一个最简单的get请求，接口如下所示：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">interface</span><span class="pln">&nbsp;</span><span class="typ">IUserBiz</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@GET</span><span class="pun">(</span><span class="str">"users"</span><span class="pun">)</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;getUsers</span><span class="pun">();</span></li><li class="L4"><span class="pun">}</span></li></ol></pre><p>可以看到有一个getUsers(）方法，通过<code>@GET</code>注解标识为get请求，<code>@GET</code>中所填写的value和<code>baseUrl</code>组成完整的路径，<code>baseUrl</code>在构造retrofit对象时给出。</p><p>下面看如何通过<code>retrofit</code>完成上述的请求：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">Retrofit</span><span class="pln">&nbsp;retrofit&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pun">.</span><span class="typ">Builder</span><span class="pun">()</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">.</span><span class="pln">baseUrl</span><span class="pun">(</span><span class="str">"http://192.168.31.242:8080/springmvc_users/user/"</span><span class="pun">)</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">.</span><span class="pln">addConverterFactory</span><span class="pun">(</span><span class="typ">GsonConverterFactory</span><span class="pun">.</span><span class="pln">create</span><span class="pun">())</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">.</span><span class="pln">build</span><span class="pun">();</span></li><li class="L4"><span class="typ">IUserBiz</span><span class="pln">&nbsp;userBiz&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;retrofit</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="typ">IUserBiz</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span></li><li class="L5"><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;call&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;userBiz</span><span class="pun">.</span><span class="pln">getUsers</span><span class="pun">();</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call</span><span class="pun">.</span><span class="pln">enqueue</span><span class="pun">(</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Callback</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;()</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;onResponse</span><span class="pun">(</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;call</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Response</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;response</span><span class="pun">)</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Log</span><span class="pun">.</span><span class="pln">e</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"normalGet:"</span><span class="pln">&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;response</span><span class="pun">.</span><span class="pln">body</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;</span><span class="str">""</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;onFailure</span><span class="pun">(</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;call</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Throwable</span><span class="pln">&nbsp;t</span><span class="pun">)</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">});</span></li></ol></pre><p>依然是构造者模式，指定了<code>baseUrl</code>和<code>Converter.Factory</code>，该对象通过名称可以看出是用于对象转化的，本例因为服务器返回的是json格式的数组，所以这里设置了<code>GsonConverterFactory</code>完成对象的转化。</p><p>ok，这里可以看到很神奇，我们通过<code>Retrofit.create</code>就可以拿到我们定义的<code>IUserBiz</code>的实例，调用其方法即可拿到一个<code>Call</code>对象，通过<code>call.enqueue</code>即可完成异步的请求。</p><p>具体retrofit怎么得到我们接口的实例的，以及对象的返回结果是如何转化的，我们后面具体分析。</p><p>这里需要指出的是：</p><ol class=" list-paddingleft-2"><li><p>接口中的方法必须有返回值，且比如是<code>Call&lt;T&gt;</code>类型</p></li><li><p><code>.addConverterFactory(GsonConverterFactory.create())</code>这里如果使用gson，需要额外导入：</p><pre class="prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="pln">compile&nbsp;</span><span class="str">'com.squareup.retrofit2:converter-gson:2.0.2'</span></li></ol></pre><p>当然除了gson以外，还提供了以下的选择：</p><pre class="prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">Gson</span><span class="pun">:</span><span class="pln">&nbsp;com</span><span class="pun">.</span><span class="pln">squareup</span><span class="pun">.</span><span class="pln">retrofit2</span><span class="pun">:</span><span class="pln">converter</span><span class="pun">-</span><span class="pln">gson</span></li><li class="L1"><span class="typ">Jackson</span><span class="pun">:</span><span class="pln">&nbsp;com</span><span class="pun">.</span><span class="pln">squareup</span><span class="pun">.</span><span class="pln">retrofit2</span><span class="pun">:</span><span class="pln">converter</span><span class="pun">-</span><span class="pln">jackson</span></li><li class="L2"><span class="typ">Moshi</span><span class="pun">:</span><span class="pln">&nbsp;com</span><span class="pun">.</span><span class="pln">squareup</span><span class="pun">.</span><span class="pln">retrofit2</span><span class="pun">:</span><span class="pln">converter</span><span class="pun">-</span><span class="pln">moshi</span></li><li class="L3"><span class="typ">Protobuf</span><span class="pun">:</span><span class="pln">&nbsp;com</span><span class="pun">.</span><span class="pln">squareup</span><span class="pun">.</span><span class="pln">retrofit2</span><span class="pun">:</span><span class="pln">converter</span><span class="pun">-</span><span class="pln">protobuf</span></li><li class="L4"><span class="typ">Wire</span><span class="pun">:</span><span class="pln">&nbsp;com</span><span class="pun">.</span><span class="pln">squareup</span><span class="pun">.</span><span class="pln">retrofit2</span><span class="pun">:</span><span class="pln">converter</span><span class="pun">-</span><span class="pln">wire</span></li><li class="L5"><span class="typ">Simple</span><span class="pln">&nbsp;XML</span><span class="pun">:</span><span class="pln">&nbsp;com</span><span class="pun">.</span><span class="pln">squareup</span><span class="pun">.</span><span class="pln">retrofit2</span><span class="pun">:</span><span class="pln">converter</span><span class="pun">-</span><span class="pln">simplexml</span></li><li class="L6"><span class="typ">Scalars</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">primitives</span><span class="pun">,</span><span class="pln">&nbsp;boxed</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="kwd">and</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pun">):</span><span class="pln">&nbsp;com</span><span class="pun">.</span><span class="pln">squareup</span><span class="pun">.</span><span class="pln">retrofit2</span><span class="pun">:</span><span class="pln">converter</span><span class="pun">-</span><span class="pln">scalars</span></li></ol></pre><p>当然也支持自定义，你可以选择自己写转化器完成数据的转化，这个后面将具体介绍。</p></li><li><p>既然<code>call.enqueue</code>是异步的访问数据，那么同步的访问方式为<code>call.execute</code>，这一点非常类似okhttp的API，实际上默认情况下内部也是通过<code>okhttp3.Call</code>实现。</p></li></ol><p>那么，通过这么一个简单的例子，应该对<code>retrofit</code>已经有了一个直观的认识，下面看更多其支持的特性。</p><h3 id="2动态的url访问path">（2）动态的url访问<code>@PATH</code></h3><p>文章开头提过，<code>retrofit</code>非常适用于<code>restful url</code>的格式，那么例如下面这样的url：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="com">//用于访问zhy的信息</span></li><li class="L1"><span class="pln">http</span><span class="pun">:</span><span class="com">//192.168.1.102:8080/springmvc_users/user/zhy</span></li><li class="L2"><span class="com">//用于访问lmj的信息</span></li><li class="L3"><span class="pln">http</span><span class="pun">:</span><span class="com">//192.168.1.102:8080/springmvc_users/user/lmj</span></li></ol></pre><p>即通过不同的username访问不同用户的信息，返回数据为json字符串。</p><p>那么可以通过retrofit提供的<code>@PATH</code>注解非常方便的完成上述需求。</p><p>我们再定义一个方法：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">interface</span><span class="pln">&nbsp;</span><span class="typ">IUserBiz</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@GET</span><span class="pun">(</span><span class="str">"{username}"</span><span class="pun">)</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;getUser</span><span class="pun">(</span><span class="lit">@Path</span><span class="pun">(</span><span class="str">"username"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;username</span><span class="pun">);</span></li><li class="L4"><span class="pun">}</span></li></ol></pre><p>可以看到我们定义了一个getUser方法，方法接收一个username参数，并且我们的<code>@GET</code>注解中使用<code>{username}</code>声明了访问路径，这里你可以把<code>{username}</code>当做占位符，而实际运行中会通过<code>@PATH("username")</code>所标注的参数进行替换。</p><p>那么访问的代码很类似：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="com">//省略了retrofit的构建代码</span></li><li class="L1"><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;call&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;userBiz</span><span class="pun">.</span><span class="pln">getUser</span><span class="pun">(</span><span class="str">"zhy"</span><span class="pun">);</span></li><li class="L2"><span class="com">//Call&lt;User&gt;&nbsp;call&nbsp;=&nbsp;userBiz.getUser("lmj");</span></li><li class="L3"><span class="pln">call</span><span class="pun">.</span><span class="pln">enqueue</span><span class="pun">(</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Callback</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;onResponse</span><span class="pun">(</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;call</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Response</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;response</span><span class="pun">)</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Log</span><span class="pun">.</span><span class="pln">e</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"getUsePath:"</span><span class="pln">&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;response</span><span class="pun">.</span><span class="pln">body</span><span class="pun">());</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;onFailure</span><span class="pun">(</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;call</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Throwable</span><span class="pln">&nbsp;t</span><span class="pun">)</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L7"><span class="pun">});</span></li></ol></pre><h3 id="3查询参数的设置query">（3）查询参数的设置<code>@Query</code></h3><p>看下面的url</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="pln">http</span><span class="pun">:</span><span class="com">//baseurl/users?sortby=username</span></li><li class="L1"><span class="pln">http</span><span class="pun">:</span><span class="com">//baseurl/users?sortby=id</span></li></ol></pre><p>即一般的传参，我们可以通过<code>@Query</code>注解方便的完成，我们再次在接口中添加一个方法：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">interface</span><span class="pln">&nbsp;</span><span class="typ">IUserBiz</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@GET</span><span class="pun">(</span><span class="str">"users"</span><span class="pun">)</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;getUsersBySort</span><span class="pun">(</span><span class="lit">@Query</span><span class="pun">(</span><span class="str">"sortby"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;sort</span><span class="pun">);</span></li><li class="L4"><span class="pun">}</span></li></ol></pre><p>访问的代码，其实没什么写的：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="com">//省略retrofit的构建代码</span></li><li class="L1"><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;call&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;userBiz</span><span class="pun">.</span><span class="pln">getUsersBySort</span><span class="pun">(</span><span class="str">"username"</span><span class="pun">);</span></li><li class="L2"><span class="com">//Call&lt;List&lt;User&gt;&gt;&nbsp;call&nbsp;=&nbsp;userBiz.getUsersBySort("id");</span></li><li class="L3"><span class="com">//省略call执行相关代码</span></li></ol></pre><p>ok，这样我们就完成了参数的指定，当然相同的方式也适用于POST，只需要把注解修改为<code>@POST</code>即可。</p><p>对了，我能刚才学了<code>@PATH</code>，那么会不会有这样尝试的冲动，对于刚才的需求，我们这么写：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="lit">@GET</span><span class="pun">(</span><span class="str">"users?sortby={sortby}"</span><span class="pun">)</span></li><li class="L1"><span class="pln">&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;getUsersBySort</span><span class="pun">(</span><span class="lit">@Path</span><span class="pun">(</span><span class="str">"sortby"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;sort</span><span class="pun">);</span></li></ol></pre><p>乍一看别说好像有点感觉，哈，实际上运行是不支持的~估计是<code>@ Path</code>的定位就是用于url的路径而不是参数，对于参数还是选择通过<code>@Query</code>来设置。</p><h3 id="4post请求体的方式向服务器传入json字符串body">（4）POST请求体的方式向服务器传入json字符串<code>@Body</code></h3><p>大家都清楚，我们app很多时候跟服务器通信，会选择直接使用POST方式将json字符串作为请求体发送到服务器，那么我们看看这个需求使用<code>retrofit</code>该如何实现。</p><p>再次添加一个方法：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">interface</span><span class="pln">&nbsp;</span><span class="typ">IUserBiz</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;</span><span class="lit">@POST</span><span class="pun">(</span><span class="str">"add"</span><span class="pun">)</span></li><li class="L3"><span class="pln">&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;addUser</span><span class="pun">(</span><span class="lit">@Body</span><span class="pln">&nbsp;</span><span class="typ">User</span><span class="pln">&nbsp;user</span><span class="pun">);</span></li><li class="L4"><span class="pun">}</span></li></ol></pre><p>提交的代码其实基本都是一致的：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="com">//省略retrofit的构建代码</span></li><li class="L1"><span class="pln">&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;call&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;userBiz</span><span class="pun">.</span><span class="pln">addUser</span><span class="pun">(</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">User</span><span class="pun">(</span><span class="lit">1001</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"jj"</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"123,"</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"jj123"</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"jj@qq.com"</span><span class="pun">));</span></li><li class="L2"><span class="com">//省略call执行相关代码</span></li></ol></pre><p>ok，可以看到其实就是使用<code>@Body</code>这个注解标识我们的参数对象即可，那么这里需要考虑一个问题，retrofit是如何将user对象转化为字符串呢？下文将详细解释~</p><p>下面对应okhttp，还有两种requestBody，一个是<code>FormBody</code>，一个是<code>MultipartBody</code>，前者以表单的方式传递简单的键值对，后者以POST表单的方式上传文件可以携带参数，<code>retrofit</code>也二者也有对应的注解，下面继续~</p><h3 id="5表单的方式传递键值对formurlencoded">（5）表单的方式传递键值对<code>@FormUrlEncoded</code></h3><p>这里我们模拟一个登录的方法，添加一个方法：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">interface</span><span class="pln">&nbsp;</span><span class="typ">IUserBiz</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@POST</span><span class="pun">(</span><span class="str">"login"</span><span class="pun">)</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@FormUrlEncoded</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;login</span><span class="pun">(</span><span class="lit">@Field</span><span class="pun">(</span><span class="str">"username"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;username</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">@Field</span><span class="pun">(</span><span class="str">"password"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;password</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li></ol></pre><p>访问的代码：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="com">//省略retrofit的构建代码</span></li><li class="L1"><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;call&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;userBiz</span><span class="pun">.</span><span class="pln">login</span><span class="pun">(</span><span class="str">"zhy"</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"123"</span><span class="pun">);</span></li><li class="L2"><span class="com">//省略call执行相关代码</span></li></ol></pre><p>ok，看起来也很简单，通过<code>@POST</code>指明url，添加<code>FormUrlEncoded</code>，然后通过<code>@Field</code>添加参数即可。</p><h3 id="6单文件上传multipart">（6）单文件上传<code>@Multipart</code></h3><p>下面看一下单文件上传，依然是再次添加个方法：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">interface</span><span class="pln">&nbsp;</span><span class="typ">IUserBiz</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Multipart</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@POST</span><span class="pun">(</span><span class="str">"register"</span><span class="pun">)</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;registerUser</span><span class="pun">(</span><span class="lit">@Part</span><span class="pln">&nbsp;</span><span class="typ">MultipartBody</span><span class="pun">.</span><span class="typ">Part</span><span class="pln">&nbsp;photo</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"username"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;username</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"password"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;password</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li></ol></pre><p>这里<code>@MultiPart</code>的意思就是允许多个<code>@Part</code>了，我们这里使用了3个<code>@Part</code>，第一个我们准备上传个文件，使用了<code>MultipartBody.Part</code>类型，其余两个均为简单的键值对。</p><p>使用：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">File</span><span class="pln">&nbsp;file&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">File</span><span class="pun">(</span><span class="typ">Environment</span><span class="pun">.</span><span class="pln">getExternalStorageDirectory</span><span class="pun">(),</span><span class="pln">&nbsp;</span><span class="str">"icon.png"</span><span class="pun">);</span></li><li class="L1"><span class="typ">RequestBody</span><span class="pln">&nbsp;photoRequestBody&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="typ">MediaType</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="str">"image/png"</span><span class="pun">),</span><span class="pln">&nbsp;file</span><span class="pun">);</span></li><li class="L2"><span class="typ">MultipartBody</span><span class="pun">.</span><span class="typ">Part</span><span class="pln">&nbsp;photo&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="typ">MultipartBody</span><span class="pun">.</span><span class="typ">Part</span><span class="pun">.</span><span class="pln">createFormData</span><span class="pun">(</span><span class="str">"photos"</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"icon.png"</span><span class="pun">,</span><span class="pln">&nbsp;photoRequestBody</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;call&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;userBiz</span><span class="pun">.</span><span class="pln">registerUser</span><span class="pun">(</span><span class="pln">photo</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"abc"</span><span class="pun">),</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"123"</span><span class="pun">));</span></li></ol></pre><p>ok，这里感觉略为麻烦。不过还是蛮好理解~~多个<code>@Part</code>，每个Part对应一个RequestBody。</p><p>这里插个实验过程，其实我最初对于文件，也是尝试的<code>@Part RequestBody</code>，因为<code>@Part("key")</code>，然后传入一个代表文件的<code>RequestBody</code>，我觉得更加容易理解，后来发现试验无法成功，而且查了下issue，给出了一个很奇怪的解决方案，这里可以参考：<a href="https://github.com/square/retrofit/issues/1063">retrofit#1063</a>。</p><p>给出了一个类似如下的方案：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">interface</span><span class="pln">&nbsp;</span><span class="typ">ApiInterface</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Multipart</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@POST</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="str">"/api/Accounts/editaccount"</span><span class="pun">)</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;editUser&nbsp;</span><span class="pun">(</span><span class="lit">@Header</span><span class="pun">(</span><span class="str">"Authorization"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;authorization</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"file\";&nbsp;filename=\"pp.png"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;file&nbsp;</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"FirstName"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;fname</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"Id"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;id</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li></ol></pre><p>可以看到对于文件的那个<code>@Part</code>value竟然写了这么多奇怪的东西，而且filename竟然硬编码了~~这个不好吧，我上传的文件名竟然不能动态指定。</p><p>为了文件名不会被写死，所以给出了最上面的上传单文件的方法，ps:上面这个方案经测试也是可以上传成功的。</p><p>恩，这个奇怪方案，为什么这么做可行，下文会给出非常详细的解释。</p><p>最后看下多文件上传~</p><h3 id="7多文件上传partmap">（7）多文件上传<code>@PartMap</code></h3><p>再添加一个方法~~~</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">interface</span><span class="pln">&nbsp;</span><span class="typ">IUserBiz</span></li><li class="L1"><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Multipart</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@POST</span><span class="pun">(</span><span class="str">"register"</span><span class="pun">)</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;registerUser</span><span class="pun">(</span><span class="lit">@PartMap</span><span class="pln">&nbsp;</span><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pun">&gt;</span><span class="pln">&nbsp;</span><span class="kwd">params</span><span class="pun">,</span><span class="pln">&nbsp;&nbsp;</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"password"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;password</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li></ol></pre><p>这里使用了一个新的注解<code>@PartMap</code>，这个注解用于标识一个Map，Map的key为String类型，代表上传的键值对的key(与服务器接受的key对应),value即为RequestBody，有点类似<code>@Part</code>的封装版本。</p><p>执行的代码：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">File</span><span class="pln">&nbsp;file&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">File</span><span class="pun">(</span><span class="typ">Environment</span><span class="pun">.</span><span class="pln">getExternalStorageDirectory</span><span class="pun">(),</span><span class="pln">&nbsp;</span><span class="str">"messenger_01.png"</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;photo&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="typ">MediaType</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="str">"image/png"</span><span class="pun">,</span><span class="pln">&nbsp;file</span><span class="pun">);</span></li><li class="L2"><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="typ">RequestBody</span><span class="pun">&gt;</span><span class="pln">&nbsp;photos&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">HashMap</span><span class="pun">&lt;&gt;();</span></li><li class="L3"><span class="pln">photos</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"photos\";&nbsp;filename=\"icon.png"</span><span class="pun">,</span><span class="pln">&nbsp;photo</span><span class="pun">);</span></li><li class="L4"><span class="pln">photos</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"username"</span><span class="pun">,</span><span class="pln">&nbsp;&nbsp;</span><span class="typ">RequestBody</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"abc"</span><span class="pun">));</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;call&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;userBiz</span><span class="pun">.</span><span class="pln">registerUser</span><span class="pun">(</span><span class="pln">photos</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"123"</span><span class="pun">));</span></li></ol></pre><p>可以看到，可以在Map中put进一个或多个文件，键值对等，当然你也可以分开，单独的键值对也可以使用<code>@Part</code>，这里又看到设置文件的时候，相对应的key很奇怪，例如上例<code>"photos\"; filename=\"icon.png"</code>,前面的photos就是与服务器对应的key，后面filename是服务器得到的文件名，ok，参数虽然奇怪，但是也可以动态的设置文件名，不太影响使用~~</p><h3 id="8下载文件">（8）下载文件</h3><p>这个其实我觉得直接使用okhttp就好了，使用retrofit去做这个事情真的有点瞎用的感觉~~</p><p>增加一个方法：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="lit">@GET</span><span class="pun">(</span><span class="str">"download"</span><span class="pun">)</span></li><li class="L1"><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">&gt;</span><span class="pln">&nbsp;downloadTest</span><span class="pun">();</span></li></ol></pre><p>调用：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">&gt;</span><span class="pln">&nbsp;call&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;userBiz</span><span class="pun">.</span><span class="pln">downloadTest</span><span class="pun">();</span></li><li class="L1"><span class="pln">call</span><span class="pun">.</span><span class="pln">enqueue</span><span class="pun">(</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Callback</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">&gt;()</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;onResponse</span><span class="pun">(</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">&gt;</span><span class="pln">&nbsp;call</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Response</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">&gt;</span><span class="pln">&nbsp;response</span><span class="pun">)</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">InputStream</span><span class="pln">&nbsp;</span><span class="kwd">is</span><span class="pln">&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;response</span><span class="pun">.</span><span class="pln">body</span><span class="pun">().</span><span class="pln">byteStream</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//save&nbsp;file</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;onFailure</span><span class="pun">(</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">&gt;</span><span class="pln">&nbsp;call</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Throwable</span><span class="pln">&nbsp;t</span><span class="pun">)</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L5"><span class="pun">});</span></li></ol></pre><p>可以看到可以返回<code>ResponseBody</code>，那么很多事都能干了~~</p><p>but，也看出这种方式下载感觉非常鸡肋，并且onReponse回调虽然在UI线程，但是你还是要处理io操作，也就是说你在这里还要另外开线程操作，或者你可以考虑同步的方式下载。</p><p>最后还是建议使用okhttp去下载，例如使用<a href="https://github.com/hongyangAndroid/okhttp-utils">okhttputils</a>.</p><p>有人可能会问，使用okhttp，和使用retrofit会不会造成新建多个<code>OkHttpClient</code>对象呢，其实是可设置的，参考下文。</p><p>ok，上面就是一些常用的方法，当然还涉及到一些没有介绍的注解，但是通过上面这么多方法的介绍，再多一二个注解的使用方式，相信大家能够解决。</p><h2 id="三配置okhttpclient">三、配置OkHttpClient</h2><p>这个需要简单提一下，很多时候，比如你使用retrofit需要统一的log管理，给每个请求添加统一的header等，这些都应该通过okhttpclient去操作，比如<code>addInterceptor</code></p><p>例如：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">OkHttpClient</span><span class="pln">&nbsp;client&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">OkHttpClient</span><span class="pun">.</span><span class="typ">Builder</span><span class="pun">().</span><span class="pln">addInterceptor</span><span class="pun">(</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Interceptor</span><span class="pun">()</span><span class="com">//log，统一的header等</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;okhttp3</span><span class="pun">.</span><span class="typ">Response</span><span class="pln">&nbsp;intercept</span><span class="pun">(</span><span class="typ">Chain</span><span class="pln">&nbsp;chain</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="kwd">throws</span><span class="pln">&nbsp;</span><span class="typ">IOException</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L7"><span class="pun">}).</span><span class="pln">build</span><span class="pun">();</span></li></ol></pre><p>或许你需要更多的配置，你可以单独写一个OkhttpClient的单例生成类，在这个里面完成你所需的所有的配置，然后将<code>OkhttpClient</code>实例通过方法公布出来，设置给retrofit。</p><p>设置方式：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">Retrofit</span><span class="pln">&nbsp;retrofit&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pun">.</span><span class="typ">Builder</span><span class="pun">()</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">.</span><span class="pln">callFactory</span><span class="pun">(</span><span class="typ">OkHttpUtils</span><span class="pun">.</span><span class="pln">getClient</span><span class="pun">())</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">.</span><span class="pln">build</span><span class="pun">();</span></li></ol></pre><p><code>callFactory</code>方法接受一个<code>okhttp3.Call.Factory</code>对象，<code>OkHttpClient</code>即为一个实现类。</p><h2 id="四retrofit-源码解析">四、retrofit 源码解析</h2><p>ok，接下来我们队retrofit的源码做简单的分析，首先我们看retrofit如何为我们的接口实现实例；然后看整体的执行流程；最后再看详细的细节；</p><h3 id="1retrofit如何为我们的接口实现实例">（1）retrofit如何为我们的接口实现实例</h3><p>通过上文的学习，我们发现使用retrofit需要去定义一个接口，然后可以通过调用<code>retrofit.create(IUserBiz.class);</code>方法，得到一个接口的实例，最后通过该实例执行我们的操作，那么retrofit如何实现我们指定接口的实例呢？</p><p>其实原理是：动态代理。但是不要被动态代理这几个词吓唬到，Java中已经提供了非常简单的API帮助我们来实现动态代理。</p><p>看源码前先看一个例子：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">interface</span><span class="pln">&nbsp;</span><span class="typ">ITest</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@GET</span><span class="pun">(</span><span class="str">"/heiheihei"</span><span class="pun">)</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;add</span><span class="pun">(</span><span class="kwd">int</span><span class="pln">&nbsp;a</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="kwd">int</span><span class="pln">&nbsp;b</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">static</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;main</span><span class="pun">(</span><span class="typ">String</span><span class="pun">[]</span><span class="pln">&nbsp;args</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">ITest</span><span class="pln">&nbsp;iTest&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">ITest</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">Proxy</span><span class="pun">.</span><span class="pln">newProxyInstance</span><span class="pun">(</span><span class="typ">ITest</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">getClassLoader</span><span class="pun">(),</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Class</span><span class="pun">&lt;?&gt;[]{</span><span class="typ">ITest</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">},</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">InvocationHandler</span><span class="pun">()</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Object</span><span class="pln">&nbsp;invoke</span><span class="pun">(</span><span class="typ">Object</span><span class="pln">&nbsp;proxy</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Method</span><span class="pln">&nbsp;method</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Object</span><span class="pun">[]</span><span class="pln">&nbsp;args</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="kwd">throws</span><span class="pln">&nbsp;</span><span class="typ">Throwable</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Integer</span><span class="pln">&nbsp;a&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">Integer</span><span class="pun">)</span><span class="pln">&nbsp;args</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Integer</span><span class="pln">&nbsp;b&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">Integer</span><span class="pun">)</span><span class="pln">&nbsp;args</span><span class="pun">[</span><span class="lit">1</span><span class="pun">];</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">System</span><span class="pun">.</span><span class="kwd">out</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"方法名："</span><span class="pln">&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;method</span><span class="pun">.</span><span class="pln">getName</span><span class="pun">());</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">System</span><span class="pun">.</span><span class="kwd">out</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"参数："</span><span class="pln">&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;a&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;</span><span class="str">"&nbsp;,&nbsp;"</span><span class="pln">&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;b</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GET&nbsp;</span><span class="kwd">get</span><span class="pln">&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;method</span><span class="pun">.</span><span class="pln">getAnnotation</span><span class="pun">(</span><span class="pln">GET</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">System</span><span class="pun">.</span><span class="kwd">out</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"注解："</span><span class="pln">&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;</span><span class="kwd">get</span><span class="pun">.</span><span class="pln">value</span><span class="pun">());</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">});</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;iTest</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">5</span><span class="pun">);</span></li><li class="L4"><span class="pun">}</span></li></ol></pre><p>输出结果为：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="pun">方法名：</span><span class="pln">add</span></li><li class="L1"><span class="pun">参数：</span><span class="lit">3</span><span class="pln">&nbsp;</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">5</span></li><li class="L2"><span class="pun">注解：/</span><span class="pln">heiheihei</span></li></ol></pre><p>可以看到我们通过<code>Proxy.newProxyInstance</code>产生的代理类，当调用接口的任何方法时，都会调用<code>InvocationHandler#invoke</code>方法，在这个方法中可以拿到传入的参数，注解等。</p><p>试想，retrofit也可以通过同样的方式，在invoke方法里面，拿到所有的参数，注解信息然后就可以去构造<code>RequestBody</code>，再去构建<code>Request</code>，得到<code>Call</code>对象封装后返回。</p><p>ok，下面看<code>retrofit#create</code>的源码：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;T&nbsp;create</span><span class="pun">(</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="typ">Class</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;service</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">T</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">Proxy</span><span class="pun">.</span><span class="pln">newProxyInstance</span><span class="pun">(</span><span class="pln">service</span><span class="pun">.</span><span class="pln">getClassLoader</span><span class="pun">(),</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Class</span><span class="pun">&lt;?&gt;[]</span><span class="pln">&nbsp;</span><span class="pun">{</span><span class="pln">&nbsp;service&nbsp;</span><span class="pun">},</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">InvocationHandler</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Object</span><span class="pln">&nbsp;invoke</span><span class="pun">(</span><span class="typ">Object</span><span class="pln">&nbsp;proxy</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Method</span><span class="pln">&nbsp;method</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Object</span><span class="pun">...</span><span class="pln">&nbsp;args</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="kwd">throws</span><span class="pln">&nbsp;</span><span class="typ">Throwable</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">});</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li></ol></pre><p>哈，和上面对应。到这里，你应该明白retrofit为我们接口生成实例对象并不神奇，仅仅是使用了<code>Proxy</code>这个类的API而已，然后在<code>invoke</code>方法里面拿到足够的信息去构建最终返回的Call而已。</p><p>哈，其实真正的动态代理一般是有具体的实现类的，只是在这个类调用某个方法的前后去执行一些别的操作，比如开事务，打log等等。当然，本博文并不需要涉及这些详细的内容，如果你希望详细去了解，可以搜索关键字：<code>Proxy InvocationHandler</code>。</p><h3 id="2retrofit整体实现流程">（2）retrofit整体实现流程</h3><h4 id="421-retrofit的构建">4.2.1 Retrofit的构建</h4><p>这里依然是通过构造者模式进行构建retrofit对象，好在其内部的成员变量比较少，我们直接看build()方法。</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Builder</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">this</span><span class="pun">(</span><span class="typ">Platform</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">());</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pln">&nbsp;build</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">baseUrl&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">throw</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">IllegalStateException</span><span class="pun">(</span><span class="str">"Base&nbsp;URL&nbsp;required."</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;okhttp3</span><span class="pun">.</span><span class="typ">Call</span><span class="pun">.</span><span class="typ">Factory</span><span class="pln">&nbsp;callFactory&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">callFactory</span><span class="pun">;</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">callFactory&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;callFactory&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">OkHttpClient</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;</span><span class="typ">Executor</span><span class="pln">&nbsp;callbackExecutor&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">callbackExecutor</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">callbackExecutor&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;callbackExecutor&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;platform</span><span class="pun">.</span><span class="pln">defaultCallbackExecutor</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;</span><span class="com">//&nbsp;Make&nbsp;a&nbsp;defensive&nbsp;copy&nbsp;of&nbsp;the&nbsp;adapters&nbsp;and&nbsp;add&nbsp;the&nbsp;default&nbsp;Call&nbsp;adapter.</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">CallAdapter</span><span class="pun">.</span><span class="typ">Factory</span><span class="pun">&gt;</span><span class="pln">&nbsp;adapterFactories&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">ArrayList</span><span class="pun">&lt;&gt;(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">adapterFactories</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;adapterFactories</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">platform</span><span class="pun">.</span><span class="pln">defaultCallAdapterFactory</span><span class="pun">(</span><span class="pln">callbackExecutor</span><span class="pun">));</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;</span><span class="com">//&nbsp;Make&nbsp;a&nbsp;defensive&nbsp;copy&nbsp;of&nbsp;the&nbsp;converters.</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Converter</span><span class="pun">.</span><span class="typ">Factory</span><span class="pun">&gt;</span><span class="pln">&nbsp;converterFactories&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">ArrayList</span><span class="pun">&lt;&gt;(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">converterFactories</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pun">(</span><span class="pln">callFactory</span><span class="pun">,</span><span class="pln">&nbsp;baseUrl</span><span class="pun">,</span><span class="pln">&nbsp;converterFactories</span><span class="pun">,</span><span class="pln">&nbsp;adapterFactories</span><span class="pun">,</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackExecutor</span><span class="pun">,</span><span class="pln">&nbsp;validateEagerly</span><span class="pun">);</span></li><li class="L8"><span class="pun">}</span></li></ol></pre><ul class=" list-paddingleft-2"><li><p>baseUrl必须指定，这个是理所当然的；</p></li><li><p>然后可以看到如果不着急设置callFactory，则默认直接<code>new OkHttpClient()</code>，可见如果你需要对okhttpclient进行详细的设置，需要构建<code>OkHttpClient</code>对象，然后传入；</p></li><li><p>接下来是callbackExecutor，这个想一想大概是用来将回调传递到UI线程了，当然这里设计的比较巧妙，利用platform对象，对平台进行判断，判断主要是利用<code>Class.forName("")</code>进行查找，具体代码已经被放到文末，如果是Android平台，会自定义一个<code>Executor</code>对象，并且利用<code>Looper.getMainLooper()</code>实例化一个handler对象，在<code>Executor</code>内部通过<code>handler.post(runnable)</code>，ok，整理凭大脑应该能构思出来，暂不贴代码了。</p></li><li><p>接下来是adapterFactories，这个对象主要用于对Call进行转化，基本上不需要我们自己去自定义。</p></li><li><p>最后是converterFactories，该对象用于转化数据，例如将返回的<code>responseBody</code>转化为对象等；当然不仅仅是针对返回的数据，还能用于一般备注解的参数的转化例如<code>@Body</code>标识的对象做一些操作，后面遇到源码详细再描述。</p></li></ul><p>ok，总体就这几个对象去构造retrofit，还算比较少的~~</p><h4 id="422-具体call构建流程">4.2.2 具体Call构建流程</h4><p>我们构造完成retrofit，就可以利用retrofit.create方法去构建接口的实例了，上面我们已经分析了这个环节利用了动态代理，而且我们也分析了具体的Call的构建流程在invoke方法中，下面看代码：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;T&nbsp;create</span><span class="pun">(</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="typ">Class</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;service</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Utils</span><span class="pun">.</span><span class="pln">validateServiceInterface</span><span class="pun">(</span><span class="pln">service</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//...</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">T</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">Proxy</span><span class="pun">.</span><span class="pln">newProxyInstance</span><span class="pun">(</span><span class="pln">service</span><span class="pun">.</span><span class="pln">getClassLoader</span><span class="pun">(),</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Class</span><span class="pun">&lt;?&gt;[]</span><span class="pln">&nbsp;</span><span class="pun">{</span><span class="pln">&nbsp;service&nbsp;</span><span class="pun">},</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">InvocationHandler</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Object</span><span class="pln">&nbsp;invoke</span><span class="pun">(</span><span class="typ">Object</span><span class="pln">&nbsp;proxy</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Method</span><span class="pln">&nbsp;method</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Object</span><span class="pun">...</span><span class="pln">&nbsp;args</span><span class="pun">){</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//...</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">ServiceMethod</span><span class="pln">&nbsp;serviceMethod&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;loadServiceMethod</span><span class="pun">(</span><span class="pln">method</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">OkHttpCall</span><span class="pln">&nbsp;okHttpCall&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">OkHttpCall</span><span class="pun">&lt;&gt;(</span><span class="pln">serviceMethod</span><span class="pun">,</span><span class="pln">&nbsp;args</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;serviceMethod</span><span class="pun">.</span><span class="pln">callAdapter</span><span class="pun">.</span><span class="pln">adapt</span><span class="pun">(</span><span class="pln">okHttpCall</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">});</span></li><li class="L3"><span class="pun">}</span></li></ol></pre><p>主要也就三行代码，第一行是根据我们的method将其包装成ServiceMethod，第二行是通过ServiceMethod和方法的参数构造<code>retrofit2.OkHttpCall</code>对象，第三行是通过<code>serviceMethod.callAdapter.adapt()</code>方法，将<code>OkHttpCall</code>进行代理包装；</p><p>下面一个一个介绍：</p><ul class=" list-paddingleft-2"><li><p>ServiceMethod应该是最复杂的一个类了，包含了将一个method转化为Call的所有的信息。</p></li></ul><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="com">#Retrofit&nbsp;class</span></li><li class="L1"><span class="typ">ServiceMethod</span><span class="pln">&nbsp;loadServiceMethod</span><span class="pun">(</span><span class="typ">Method</span><span class="pln">&nbsp;method</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">ServiceMethod</span><span class="pln">&nbsp;result</span><span class="pun">;</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">synchronized</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">serviceMethodCache</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;serviceMethodCache</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">method</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">result&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">ServiceMethod</span><span class="pun">.</span><span class="typ">Builder</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln">&nbsp;method</span><span class="pun">).</span><span class="pln">build</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceMethodCache</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="pln">method</span><span class="pun">,</span><span class="pln">&nbsp;result</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;result</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">#ServiceMethod</span></li><li class="L4"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">ServiceMethod</span><span class="pln">&nbsp;build</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callAdapter&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;createCallAdapter</span><span class="pun">();</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;responseType&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;callAdapter</span><span class="pun">.</span><span class="pln">responseType</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">responseType&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;</span><span class="typ">Response</span><span class="pun">.</span><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="pun">||</span><span class="pln">&nbsp;responseType&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;okhttp3</span><span class="pun">.</span><span class="typ">Response</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">throw</span><span class="pln">&nbsp;methodError</span><span class="pun">(</span><span class="str">"'"</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;</span><span class="typ">Utils</span><span class="pun">.</span><span class="pln">getRawType</span><span class="pun">(</span><span class="pln">responseType</span><span class="pun">).</span><span class="pln">getName</span><span class="pun">()</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;</span><span class="str">"'&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;response&nbsp;body&nbsp;type.&nbsp;Did&nbsp;you&nbsp;mean&nbsp;ResponseBody?"</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;responseConverter&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;createResponseConverter</span><span class="pun">();</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">for</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">Annotation</span><span class="pln">&nbsp;annotation&nbsp;</span><span class="pun">:</span><span class="pln">&nbsp;methodAnnotations</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseMethodAnnotation</span><span class="pun">(</span><span class="pln">annotation</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">int</span><span class="pln">&nbsp;parameterCount&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;parameterAnnotationsArray</span><span class="pun">.</span><span class="pln">length</span><span class="pun">;</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameterHandlers&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">ParameterHandler</span><span class="pun">&lt;?&gt;[</span><span class="pln">parameterCount</span><span class="pun">];</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">for</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="kwd">int</span><span class="pln">&nbsp;p&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">;</span><span class="pln">&nbsp;p&nbsp;</span><span class="pun">&lt;</span><span class="pln">&nbsp;parameterCount</span><span class="pun">;</span><span class="pln">&nbsp;p</span><span class="pun">++)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Type</span><span class="pln">&nbsp;parameterType&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;parameterTypes</span><span class="pun">[</span><span class="pln">p</span><span class="pun">];</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">Utils</span><span class="pun">.</span><span class="pln">hasUnresolvableType</span><span class="pun">(</span><span class="pln">parameterType</span><span class="pun">))</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">throw</span><span class="pln">&nbsp;parameterError</span><span class="pun">(</span><span class="pln">p</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"Parameter&nbsp;type&nbsp;must&nbsp;not&nbsp;include&nbsp;a&nbsp;type&nbsp;variable&nbsp;or&nbsp;wildcard:&nbsp;%s"</span><span class="pun">,</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameterType</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Annotation</span><span class="pun">[]</span><span class="pln">&nbsp;parameterAnnotations&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;parameterAnnotationsArray</span><span class="pun">[</span><span class="pln">p</span><span class="pun">];</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">parameterAnnotations&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">throw</span><span class="pln">&nbsp;parameterError</span><span class="pun">(</span><span class="pln">p</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"No&nbsp;Retrofit&nbsp;annotation&nbsp;found."</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameterHandlers</span><span class="pun">[</span><span class="pln">p</span><span class="pun">]</span><span class="pln">&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;parseParameter</span><span class="pun">(</span><span class="pln">p</span><span class="pun">,</span><span class="pln">&nbsp;parameterType</span><span class="pun">,</span><span class="pln">&nbsp;parameterAnnotations</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">ServiceMethod</span><span class="pun">&lt;&gt;(</span><span class="kwd">this</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li></ol></pre><p>直接看build方法，首先拿到这个callAdapter最终拿到的是我们在构建retrofit里面时adapterFactories时添加的，即为：<code>new ExecutorCallbackCall&lt;&gt;(callbackExecutor, call)</code>，该<code>ExecutorCallbackCall</code>唯一做的事情就是将原本call的回调转发至UI线程。</p><p>接下来通过<code>callAdapter.responseType()</code>返回的是我们方法的实际类型，例如:<code>Call&lt;User&gt;</code>,则返回<code>User</code>类型，然后对该类型进行判断。</p><p>接下来是<code>createResponseConverter</code>拿到responseConverter对象，其当然也是根据我们构建retrofit时,<code>addConverterFactory</code>添加的ConverterFactory对象来寻找一个合适的返回，寻找的依据主要看该converter能否处理你编写方法的返回值类型，默认实现为<code>BuiltInConverters</code>，仅仅支持返回值的实际类型为<code>ResponseBody</code>和<code>Void</code>，也就说明了默认情况下，是不支持<code>Call&lt;User&gt;</code>这类类型的。</p><p>接下来就是对注解进行解析了，主要是对方法上的注解进行解析，那么可以拿到httpMethod以及初步的url（包含占位符）。</p><p>后面是对方法中参数中的注解进行解析，这一步会拿到很多的<code>ParameterHandler</code>对象，该对象在<code>toRequest()</code>构造Request的时候调用其apply方法。</p><p>ok，这里我们并没有去一行一行查看代码，其实意义也不太大，只要知道ServiceMethod主要用于将我们<code>接口中的方法</code>转化为一个<code>Request对象</code>，于是根据我们的接口返回值确定了responseConverter,解析我们方法上的注解拿到初步的url,解析我们参数上的注解拿到构建RequestBody所需的各种信息，最终调用toRequest的方法完成Request的构建。</p><ul class=" list-paddingleft-2"><li><p>接下来看OkHttpCall的构建，构造函数仅仅是简单的赋值</p></li></ul><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">OkHttpCall</span><span class="pun">(</span><span class="typ">ServiceMethod</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;serviceMethod</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Object</span><span class="pun">[]</span><span class="pln">&nbsp;args</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">serviceMethod&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;serviceMethod</span><span class="pun">;</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">args&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;args</span><span class="pun">;</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li></ol></pre><ul class=" list-paddingleft-2"><li><p>最后一步是<code>serviceMethod.callAdapter.adapt(okHttpCall)</code></p></li></ul><p>我们已经确定这个callAdapter是<code>ExecutorCallAdapterFactory.get()</code>对应代码为：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="typ">ExecutorCallAdapterFactory</span><span class="pln">&nbsp;</span><span class="kwd">extends</span><span class="pln">&nbsp;</span><span class="typ">CallAdapter</span><span class="pun">.</span><span class="typ">Factory</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="typ">Executor</span><span class="pln">&nbsp;callbackExecutor</span><span class="pun">;</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;</span><span class="typ">ExecutorCallAdapterFactory</span><span class="pun">(</span><span class="typ">Executor</span><span class="pln">&nbsp;callbackExecutor</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">callbackExecutor&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;callbackExecutor</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">CallAdapter</span><span class="pun">&lt;</span><span class="typ">Call</span><span class="pun">&lt;?&gt;&gt;</span><span class="pln">&nbsp;</span><span class="kwd">get</span><span class="pun">(</span><span class="typ">Type</span><span class="pln">&nbsp;returnType</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Annotation</span><span class="pun">[]</span><span class="pln">&nbsp;annotations</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pln">&nbsp;retrofit</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">getRawType</span><span class="pun">(</span><span class="pln">returnType</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">!=</span><span class="pln">&nbsp;</span><span class="typ">Call</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="typ">Type</span><span class="pln">&nbsp;responseType&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="typ">Utils</span><span class="pun">.</span><span class="pln">getCallResponseType</span><span class="pun">(</span><span class="pln">returnType</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">CallAdapter</span><span class="pun">&lt;</span><span class="typ">Call</span><span class="pun">&lt;?&gt;&gt;()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span><span class="pln">&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Type</span><span class="pln">&nbsp;responseType</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;responseType</span><span class="pun">;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span><span class="pln">&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="pun">&lt;</span><span class="pln">R</span><span class="pun">&gt;</span><span class="pln">&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="pln">R</span><span class="pun">&gt;</span><span class="pln">&nbsp;adapt</span><span class="pun">(</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="pln">R</span><span class="pun">&gt;</span><span class="pln">&nbsp;call</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">ExecutorCallbackCall</span><span class="pun">&lt;&gt;(</span><span class="pln">callbackExecutor</span><span class="pun">,</span><span class="pln">&nbsp;call</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">};</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li></ol></pre><p>可以看到<code>adapt</code>返回的是<code>ExecutorCallbackCall</code>对象，继续往下看：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">static</span><span class="pln">&nbsp;</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="typ">ExecutorCallbackCall</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;</span><span class="kwd">implements</span><span class="pln">&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="typ">Executor</span><span class="pln">&nbsp;callbackExecutor</span><span class="pun">;</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;</span><span class="kwd">delegate</span><span class="pun">;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">ExecutorCallbackCall</span><span class="pun">(</span><span class="typ">Executor</span><span class="pln">&nbsp;callbackExecutor</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;</span><span class="kwd">delegate</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">callbackExecutor&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;callbackExecutor</span><span class="pun">;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">this</span><span class="pun">.</span><span class="kwd">delegate</span><span class="pln">&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">delegate</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span><span class="pln">&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;enqueue</span><span class="pun">(</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="typ">Callback</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;callback</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">callback&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="kwd">throw</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">NullPointerException</span><span class="pun">(</span><span class="str">"callback&nbsp;==&nbsp;null"</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">delegate</span><span class="pun">.</span><span class="pln">enqueue</span><span class="pun">(</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Callback</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span><span class="pln">&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;onResponse</span><span class="pun">(</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;call</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="typ">Response</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;response</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackExecutor</span><span class="pun">.</span><span class="pln">execute</span><span class="pun">(</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Runnable</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span><span class="pln">&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;run</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="kwd">delegate</span><span class="pun">.</span><span class="pln">isCanceled</span><span class="pun">())</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//&nbsp;Emulate&nbsp;OkHttp's&nbsp;behavior&nbsp;of&nbsp;throwing/delivering&nbsp;an&nbsp;IOException&nbsp;on&nbsp;cancellation.</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback</span><span class="pun">.</span><span class="pln">onFailure</span><span class="pun">(</span><span class="typ">ExecutorCallbackCall</span><span class="pun">.</span><span class="kwd">this</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">IOException</span><span class="pun">(</span><span class="str">"Canceled"</span><span class="pun">));</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">else</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback</span><span class="pun">.</span><span class="pln">onResponse</span><span class="pun">(</span><span class="typ">ExecutorCallbackCall</span><span class="pun">.</span><span class="kwd">this</span><span class="pun">,</span><span class="pln">&nbsp;response</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">});</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span><span class="pln">&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;onFailure</span><span class="pun">(</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;call</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="typ">Throwable</span><span class="pln">&nbsp;t</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbackExecutor</span><span class="pun">.</span><span class="pln">execute</span><span class="pun">(</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Runnable</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span><span class="pln">&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;run</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback</span><span class="pun">.</span><span class="pln">onFailure</span><span class="pun">(</span><span class="typ">ExecutorCallbackCall</span><span class="pun">.</span><span class="kwd">this</span><span class="pun">,</span><span class="pln">&nbsp;t</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">});</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">});</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span><span class="pln">&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Response</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;execute</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="kwd">throws</span><span class="pln">&nbsp;</span><span class="typ">IOException</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">delegate</span><span class="pun">.</span><span class="pln">execute</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li></ol></pre><p>可以看出ExecutorCallbackCall仅仅是对Call对象进行封装，类似装饰者模式，只不过将其执行时的回调通过callbackExecutor进行回调到UI线程中去了。</p><h4 id="423-执行call">4.2.3 执行Call</h4><p>在4.2.2我们已经拿到了经过封装的<code>ExecutorCallbackCall</code>类型的call对象，实际上就是我们实际在写代码时拿到的call对象，那么我们一般会执行<code>enqueue</code>方法，看看源码是怎么做的</p><p>首先是<code>ExecutorCallbackCall.enqueue</code>方法，代码在4.2.2，可以看到除了将onResponse和onFailure回调到UI线程，主要的操作还是delegate完成的，这个delegate实际上就是OkHttpCall对象，我们看它的enqueue方法</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="pln">&nbsp;</span><span class="lit">@Override</span></li><li class="L1"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;enqueue</span><span class="pun">(</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="typ">Callback</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;callback</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;okhttp3</span><span class="pun">.</span><span class="typ">Call</span><span class="pln">&nbsp;call</span><span class="pun">;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Throwable</span><span class="pln">&nbsp;failure</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">synchronized</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">)</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">executed</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="kwd">throw</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">IllegalStateException</span><span class="pun">(</span><span class="str">"Already&nbsp;executed."</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;executed&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">true</span><span class="pun">;</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">try</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;rawCall&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;createRawCall</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">catch</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">Throwable</span><span class="pln">&nbsp;t</span><span class="pun">)</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failure&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;creationFailure&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;t</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">failure&nbsp;</span><span class="pun">!=</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">)</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback</span><span class="pun">.</span><span class="pln">onFailure</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln">&nbsp;failure</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pun">;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">canceled</span><span class="pun">)</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call</span><span class="pun">.</span><span class="pln">cancel</span><span class="pun">();</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;call</span><span class="pun">.</span><span class="pln">enqueue</span><span class="pun">(</span><span class="kwd">new</span><span class="pln">&nbsp;okhttp3</span><span class="pun">.</span><span class="typ">Callback</span><span class="pun">()</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;onResponse</span><span class="pun">(</span><span class="pln">okhttp3</span><span class="pun">.</span><span class="typ">Call</span><span class="pln">&nbsp;call</span><span class="pun">,</span><span class="pln">&nbsp;okhttp3</span><span class="pun">.</span><span class="typ">Response</span><span class="pln">&nbsp;rawResponse</span><span class="pun">)</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">throws</span><span class="pln">&nbsp;</span><span class="typ">IOException</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Response</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;response</span><span class="pun">;</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">try</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;parseResponse</span><span class="pun">(</span><span class="pln">rawResponse</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">catch</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">Throwable</span><span class="pln">&nbsp;e</span><span class="pun">)</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callFailure</span><span class="pun">(</span><span class="pln">e</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callSuccess</span><span class="pun">(</span><span class="pln">response</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;onFailure</span><span class="pun">(</span><span class="pln">okhttp3</span><span class="pun">.</span><span class="typ">Call</span><span class="pln">&nbsp;call</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">IOException</span><span class="pln">&nbsp;e</span><span class="pun">)</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">try</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback</span><span class="pun">.</span><span class="pln">onFailure</span><span class="pun">(</span><span class="typ">OkHttpCall</span><span class="pun">.</span><span class="kwd">this</span><span class="pun">,</span><span class="pln">&nbsp;e</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">catch</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">Throwable</span><span class="pln">&nbsp;t</span><span class="pun">)</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t</span><span class="pun">.</span><span class="pln">printStackTrace</span><span class="pun">();</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">private</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;callFailure</span><span class="pun">(</span><span class="typ">Throwable</span><span class="pln">&nbsp;e</span><span class="pun">)</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">try</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback</span><span class="pun">.</span><span class="pln">onFailure</span><span class="pun">(</span><span class="typ">OkHttpCall</span><span class="pun">.</span><span class="kwd">this</span><span class="pun">,</span><span class="pln">&nbsp;e</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">catch</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">Throwable</span><span class="pln">&nbsp;t</span><span class="pun">)</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t</span><span class="pun">.</span><span class="pln">printStackTrace</span><span class="pun">();</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">private</span><span class="pln">&nbsp;</span><span class="kwd">void</span><span class="pln">&nbsp;callSuccess</span><span class="pun">(</span><span class="typ">Response</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;response</span><span class="pun">)</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">try</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback</span><span class="pun">.</span><span class="pln">onResponse</span><span class="pun">(</span><span class="typ">OkHttpCall</span><span class="pun">.</span><span class="kwd">this</span><span class="pun">,</span><span class="pln">&nbsp;response</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">catch</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">Throwable</span><span class="pln">&nbsp;t</span><span class="pun">)</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t</span><span class="pun">.</span><span class="pln">printStackTrace</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">});</span></li><li class="L3"><span class="pun">}</span></li></ol></pre><p>没有任何神奇的地方，内部实际上就是okhttp的Call对象，也是调用<code>okhttp3.Call.enqueue</code>方法。</p><p>中间对于<code>okhttp3.Call</code>的创建代码为：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">private</span><span class="pln">&nbsp;okhttp3</span><span class="pun">.</span><span class="typ">Call</span><span class="pln">&nbsp;createRawCall</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="kwd">throws</span><span class="pln">&nbsp;</span><span class="typ">IOException</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Request</span><span class="pln">&nbsp;request&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;serviceMethod</span><span class="pun">.</span><span class="pln">toRequest</span><span class="pun">(</span><span class="pln">args</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;okhttp3</span><span class="pun">.</span><span class="typ">Call</span><span class="pln">&nbsp;call&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;serviceMethod</span><span class="pun">.</span><span class="pln">callFactory</span><span class="pun">.</span><span class="pln">newCall</span><span class="pun">(</span><span class="pln">request</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">call&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">)</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">throw</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">NullPointerException</span><span class="pun">(</span><span class="str">"Call.Factory&nbsp;returned&nbsp;null."</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;call</span><span class="pun">;</span></li><li class="L9"><span class="pun">}</span></li></ol></pre><p>可以看到，通过<code>serviceMethod.toRequest</code>完成对request的构建，通过request去构造call对象，然后返回.</p><p>中间还涉及一个<code>parseResponse</code>方法，如果顺利的话，执行的代码如下：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">Response</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;parseResponse</span><span class="pun">(</span><span class="pln">okhttp3</span><span class="pun">.</span><span class="typ">Response</span><span class="pln">&nbsp;rawResponse</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="kwd">throws</span><span class="pln">&nbsp;</span><span class="typ">IOException</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">ResponseBody</span><span class="pln">&nbsp;rawBody&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;rawResponse</span><span class="pun">.</span><span class="pln">body</span><span class="pun">();</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">ExceptionCatchingRequestBody</span><span class="pln">&nbsp;catchingBody&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">ExceptionCatchingRequestBody</span><span class="pun">(</span><span class="pln">rawBody</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;T&nbsp;body&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;serviceMethod</span><span class="pun">.</span><span class="pln">toResponse</span><span class="pun">(</span><span class="pln">catchingBody</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="typ">Response</span><span class="pun">.</span><span class="pln">success</span><span class="pun">(</span><span class="pln">body</span><span class="pun">,</span><span class="pln">&nbsp;rawResponse</span><span class="pun">);</span></li></ol></pre><p>通过serviceMethod对ResponseBody进行转化，然后返回，转化实际上就是通过<code>responseConverter</code>的convert方法。</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="com">#ServiceMethod</span></li><li class="L1"><span class="pln">&nbsp;T&nbsp;toResponse</span><span class="pun">(</span><span class="typ">ResponseBody</span><span class="pln">&nbsp;body</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="kwd">throws</span><span class="pln">&nbsp;</span><span class="typ">IOException</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;responseConverter</span><span class="pun">.</span><span class="pln">convert</span><span class="pun">(</span><span class="pln">body</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li></ol></pre><p>ok，关于<code>responseConverter</code>后面还会细说，不用担心。</p><p>到这里，我们整个源码的流程分析就差不多了，目的就掌握一个大体的原理和执行流程，了解下几个核心的类。</p><p>那么总结一下：</p><ul class=" list-paddingleft-2"><li><p>首先构造retrofit，几个核心的参数呢，主要就是baseurl,callFactory(默认okhttpclient),converterFactories,adapterFactories,excallbackExecutor。</p></li><li><p>然后通过create方法拿到接口的实现类，这里利用Java的<code>Proxy</code>类完成动态代理的相关代理</p></li><li><p>在invoke方法内部，拿到我们所声明的注解以及实参等，构造ServiceMethod，ServiceMethod中解析了大量的信息，最痛可以通过<code>toRequest</code>构造出<code>okhttp3.Request</code>对象。有了<code>okhttp3.Request</code>对象就可以很自然的构建出<code>okhttp3.call</code>，最后calladapter对Call进行装饰返回。</p></li><li><p>拿到Call就可以执行enqueue或者execute方法了</p></li></ul><p>ok,了解这么多足以。</p><p>下面呢，有几个地方需要注意，一方面是一些特殊的细节；另一方面就是<code>Converter</code>。</p><h2 id="五retrofit中的各类细节">五、retrofit中的各类细节</h2><h3 id="1上传文件中使用的奇怪value值">（1）上传文件中使用的奇怪value值</h3><p>第一个问题涉及到文件上传，还记得我们在单文件上传那里所说的吗？有种类似于hack的写法，上传文件是这么做的？</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">interface</span><span class="pln">&nbsp;</span><span class="typ">ApiInterface</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Multipart</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@POST</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="str">"/api/Accounts/editaccount"</span><span class="pun">)</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;editUser&nbsp;</span><span class="pun">(</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"file_key\";&nbsp;filename=\"pp.png"</span><span class="pun">),</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"username"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;username</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li></ol></pre><p>首先我们一点明确，因为这里使用了<code>@ Multipart</code>，那么我们认为<code>@Part</code>应当支持普通的key-value，以及文件。</p><p>对于普通的key-value是没问题的，只需要这样<code>@Part("username") String username</code>。</p><p>那么对于文件，为什么需要这样呢？<code>@Part("file_key\"; filename=\"pp.png")</code></p><p>这个value设置的值不用看就会觉得特别奇怪，然而却可以正常执行，原因是什么呢？</p><p>原因是这样的：</p><p>当上传key-value的时候，实际上对应这样的代码：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="pln">builder</span><span class="pun">.</span><span class="pln">addPart</span><span class="pun">(</span><span class="typ">Headers</span><span class="pun">.</span><span class="pln">of</span><span class="pun">(</span><span class="str">"Content-Disposition"</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"form-data;&nbsp;name=\""</span><span class="pln">&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;key&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;</span><span class="str">"\""</span><span class="pun">),</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">RequestBody</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="kwd">params</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">key</span><span class="pun">)));</span></li></ol></pre><p>也就是说，我们的<code>@Part</code>转化为了</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">Headers</span><span class="pun">.</span><span class="pln">of</span><span class="pun">(</span><span class="str">"Content-Disposition"</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"form-data;&nbsp;name=\""</span><span class="pln">&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;key&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;</span><span class="str">"\""</span><span class="pun">)</span></li></ol></pre><p>这么一看，很随意，只要把key放进去就可以了。</p><p>但是，retrofit2并没有对文件做特殊处理，文件的对应的字符串应该是这样的</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">Headers</span><span class="pun">.</span><span class="pln">of</span><span class="pun">(</span><span class="str">"Content-Disposition"</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"form-data;&nbsp;name="</span><span class="pln">filekey</span><span class="str">";filename="</span><span class="pln">filename</span><span class="pun">.</span><span class="pln">png</span><span class="str">");</span></li></ol></pre><p>与键值对对应的字符串相比，多了个<code>;filename="filename.png</code>，就因为retrofit没有做特殊处理，所以你现在看这些hack的做法</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="lit">@Part</span><span class="pun">(</span><span class="str">"file_key\";&nbsp;filename=\"pp.png"</span><span class="pun">)</span></li><li class="L1"><span class="pun">拼接：==&gt;</span></li><li class="L2"><span class="typ">Content</span><span class="pun">-</span><span class="typ">Disposition</span><span class="str">",&nbsp;"</span><span class="pln">form</span><span class="pun">-</span><span class="pln">data</span><span class="pun">;</span><span class="pln">&nbsp;name</span><span class="pun">=</span><span class="pln">\"</span><span class="str">"&nbsp;+&nbsp;key&nbsp;+&nbsp;"</span><span class="pln">\"</span></li><li class="L3"><span class="pun">结果：==&gt;</span></li><li class="L4"><span class="typ">Content</span><span class="pun">-</span><span class="typ">Disposition</span><span class="str">",&nbsp;"</span><span class="pln">form</span><span class="pun">-</span><span class="pln">data</span><span class="pun">;</span><span class="pln">&nbsp;name</span><span class="pun">=</span><span class="pln">file_key\"</span><span class="pun">;</span><span class="pln">&nbsp;filename</span><span class="pun">=</span><span class="pln">\"pp</span><span class="pun">.</span><span class="pln">png\"</span></li></ol></pre><p>ok，到这里我相信你已经理解了，为什么要这么做，而且为什么这么做可以成功！</p><p>恩，值得一提的事，因为这种方式文件名写死了，我们上文使用的的是<code>@Part MultipartBody.Part file</code>,可以满足文件名动态设置，这个方式貌似也是2.0.1的时候支持的。</p><p>上述相关的源码：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="com">#ServiceMethod</span></li><li class="L1"><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">annotation&nbsp;</span><span class="kwd">instanceof</span><span class="pln">&nbsp;</span><span class="typ">Part</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(!</span><span class="pln">isMultipart</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">throw</span><span class="pln">&nbsp;parameterError</span><span class="pun">(</span><span class="pln">p</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"@Part&nbsp;parameters&nbsp;can&nbsp;only&nbsp;be&nbsp;used&nbsp;with&nbsp;multipart&nbsp;encoding."</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Part</span><span class="pln">&nbsp;part&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">Part</span><span class="pun">)</span><span class="pln">&nbsp;annotation</span><span class="pun">;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;gotPart&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">true</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;partName&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;part</span><span class="pun">.</span><span class="pln">value</span><span class="pun">();</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Headers</span><span class="pln">&nbsp;headers&nbsp;</span><span class="pun">=</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Headers</span><span class="pun">.</span><span class="pln">of</span><span class="pun">(</span><span class="str">"Content-Disposition"</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="str">"form-data;&nbsp;name=\""</span><span class="pln">&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;partName&nbsp;</span><span class="pun">+</span><span class="pln">&nbsp;</span><span class="str">"\""</span><span class="pun">,</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="str">"Content-Transfer-Encoding"</span><span class="pun">,</span><span class="pln">&nbsp;part</span><span class="pun">.</span><span class="pln">encoding</span><span class="pun">());</span></li><li class="L3"><span class="pun">}</span></li></ol></pre><p>可以看到呢，并没有对文件做特殊处理，估计下个版本说不定<code>@Part</code>会多个<code>isFile=true|false</code>属性，甚至修改对应形参，然后在这里做简单的处理。</p><p>ok，最后来到关键的<code>ConverterFactory</code>了~</p><h2 id="六自定义converterfactory">六、自定义Converter.Factory</h2><h3 id="1responsebodyconverter">（1）responseBodyConverter</h3><p>关于<code>Converter.Factory</code>，肯定是通过<code>addConverterFactory</code>设置的</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="typ">Retrofit</span><span class="pln">&nbsp;retrofit&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pun">.</span><span class="typ">Builder</span><span class="pun">()</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">.</span><span class="pln">addConverterFactory</span><span class="pun">(</span><span class="typ">GsonConverterFactory</span><span class="pun">.</span><span class="pln">create</span><span class="pun">())</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">.</span><span class="pln">build</span><span class="pun">();</span></li></ol></pre><p>该方法接受的是一个<code>Converter.Factory factory</code>对象</p><p>该对象呢，是一个抽象类，内部包含3个方法：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">abstract</span><span class="pln">&nbsp;</span><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="typ">Factory</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="pun">?&gt;</span><span class="pln">&nbsp;responseBodyConverter</span><span class="pun">(</span><span class="typ">Type</span><span class="pln">&nbsp;type</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Annotation</span><span class="pun">[]</span><span class="pln">&nbsp;annotations</span><span class="pun">,</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Retrofit</span><span class="pln">&nbsp;retrofit</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">&lt;?,</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pun">&gt;</span><span class="pln">&nbsp;requestBodyConverter</span><span class="pun">(</span><span class="typ">Type</span><span class="pln">&nbsp;type</span><span class="pun">,</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Annotation</span><span class="pun">[]</span><span class="pln">&nbsp;parameterAnnotations</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Annotation</span><span class="pun">[]</span><span class="pln">&nbsp;methodAnnotations</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pln">&nbsp;retrofit</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">&lt;?,</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pun">&gt;</span><span class="pln">&nbsp;stringConverter</span><span class="pun">(</span><span class="typ">Type</span><span class="pln">&nbsp;type</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Annotation</span><span class="pun">[]</span><span class="pln">&nbsp;annotations</span><span class="pun">,</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Retrofit</span><span class="pln">&nbsp;retrofit</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li></ol></pre><p>可以看到呢，3个方法都是空方法而不是抽象的方法，也就表明了我们可以选择去实现其中的1个或多个方法，一般只需要关注<code>requestBodyConverter</code>和<code>responseBodyConverter</code>就可以了。</p><p>ok，我们先看如何自定义，最后再看<code>GsonConverterFactory.create</code>的源码。</p><p>先来个简单的，实现<code>responseBodyConverter</code>方法，看这个名字很好理解，就是将responseBody进行转化就可以了。</p><p>ok，这里呢，我们先看一下上述中我们使用的接口：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">package</span><span class="pln">&nbsp;com</span><span class="pun">.</span><span class="pln">zhy</span><span class="pun">.</span><span class="pln">retrofittest</span><span class="pun">.</span><span class="pln">userBiz</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">interface</span><span class="pln">&nbsp;</span><span class="typ">IUserBiz</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@GET</span><span class="pun">(</span><span class="str">"users"</span><span class="pun">)</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;getUsers</span><span class="pun">();</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@POST</span><span class="pun">(</span><span class="str">"users"</span><span class="pun">)</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;getUsersBySort</span><span class="pun">(</span><span class="lit">@Query</span><span class="pun">(</span><span class="str">"sort"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;sort</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@GET</span><span class="pun">(</span><span class="str">"{username}"</span><span class="pun">)</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;getUser</span><span class="pun">(</span><span class="lit">@Path</span><span class="pun">(</span><span class="str">"username"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;username</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@POST</span><span class="pun">(</span><span class="str">"add"</span><span class="pun">)</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;addUser</span><span class="pun">(</span><span class="lit">@Body</span><span class="pln">&nbsp;</span><span class="typ">User</span><span class="pln">&nbsp;user</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@POST</span><span class="pun">(</span><span class="str">"login"</span><span class="pun">)</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@FormUrlEncoded</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;login</span><span class="pun">(</span><span class="lit">@Field</span><span class="pun">(</span><span class="str">"username"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;username</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">@Field</span><span class="pun">(</span><span class="str">"password"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;password</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Multipart</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@POST</span><span class="pun">(</span><span class="str">"register"</span><span class="pun">)</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;registerUser</span><span class="pun">(</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"photos"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;photos</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"username"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;username</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"password"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;password</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Multipart</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@POST</span><span class="pun">(</span><span class="str">"register"</span><span class="pun">)</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;registerUser</span><span class="pun">(</span><span class="lit">@PartMap</span><span class="pln">&nbsp;</span><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pun">&gt;</span><span class="pln">&nbsp;</span><span class="kwd">params</span><span class="pun">,</span><span class="pln">&nbsp;&nbsp;</span><span class="lit">@Part</span><span class="pun">(</span><span class="str">"password"</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;password</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@GET</span><span class="pun">(</span><span class="str">"download"</span><span class="pun">)</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">&gt;</span><span class="pln">&nbsp;downloadTest</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pun">}</span></li></ol></pre><p>不知不觉，方法还蛮多的，假设哈，我们这里去掉retrofit构造时的<code>GsonConverterFactory.create</code>，自己实现一个<code>Converter.Factory</code>来做数据的转化工作。</p><p>首先我们解决<code>responseBodyConverter</code>，那么代码很简单，我们可以这么写：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="typ">UserConverterFactory</span><span class="pln">&nbsp;</span><span class="kwd">extends</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">.</span><span class="typ">Factory</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="pun">?&gt;</span><span class="pln">&nbsp;responseBodyConverter</span><span class="pun">(</span><span class="typ">Type</span><span class="pln">&nbsp;type</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Annotation</span><span class="pun">[]</span><span class="pln">&nbsp;annotations</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pln">&nbsp;retrofit</span><span class="pun">)</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//根据type判断是否是自己能处理的类型，不能的话，return&nbsp;null&nbsp;,交给后面的Converter.Factory</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">UserConverter</span><span class="pun">(</span><span class="pln">type</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="typ">UserResponseConverter</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;</span><span class="kwd">implements</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">,</span><span class="pln">&nbsp;T</span><span class="pun">&gt;</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">private</span><span class="pln">&nbsp;</span><span class="typ">Type</span><span class="pln">&nbsp;type</span><span class="pun">;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Gson</span><span class="pln">&nbsp;gson&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Gson</span><span class="pun">();</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">UserResponseConverter</span><span class="pun">(</span><span class="typ">Type</span><span class="pln">&nbsp;type</span><span class="pun">)</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">type&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;type</span><span class="pun">;</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;T&nbsp;convert</span><span class="pun">(</span><span class="typ">ResponseBody</span><span class="pln">&nbsp;responseBody</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="kwd">throws</span><span class="pln">&nbsp;</span><span class="typ">IOException</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;result&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;responseBody</span><span class="pun">.</span><span class="kwd">string</span><span class="pun">();</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;T&nbsp;users&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;gson</span><span class="pun">.</span><span class="pln">fromJson</span><span class="pun">(</span><span class="pln">result</span><span class="pun">,</span><span class="pln">&nbsp;type</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;users</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pun">}</span></li></ol></pre><p>使用的时候呢，可以</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pln">&nbsp;retrofit&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pun">.</span><span class="typ">Builder</span><span class="pun">()</span></li><li class="L1"><span class="pun">.</span><span class="pln">callFactory</span><span class="pun">(</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">OkHttpClient</span><span class="pun">())</span><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">.</span><span class="pln">baseUrl</span><span class="pun">(</span><span class="str">"http://example/springmvc_users/user/"</span><span class="pun">)</span></li><li class="L2"><span class="com">//.addConverterFactory(GsonConverterFactory.create())</span></li><li class="L3"><span class="pun">.</span><span class="pln">addConverterFactory</span><span class="pun">(</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">UserConverterFactory</span><span class="pun">())</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">.</span><span class="pln">build</span><span class="pun">();</span></li></ol></pre><p>ok，这样的话，就可以完成我们的<code>ReponseBody</code>到<code>List&lt;User&gt;</code>或者<code>User</code>的转化了。</p><p>可以看出，我们这里用的依然是Gson，那么有些同学肯定不希望使用Gson就能实现，如果不使用Gson的话，一般需要针对具体的返回类型，比如我们针对返回<code>List&lt;User&gt;</code>或者<code>User</code></p><p>你可以这么写：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">package</span><span class="pln">&nbsp;com</span><span class="pun">.</span><span class="pln">zhy</span><span class="pun">.</span><span class="pln">retrofittest</span><span class="pun">.</span><span class="pln">converter</span><span class="pun">;</span></li><li class="L1"><span class="com">/**</span></li><li class="L2"><span class="com">&nbsp;*&nbsp;Created&nbsp;by&nbsp;zhy&nbsp;on&nbsp;16/4/30.</span></li><li class="L3"><span class="com">&nbsp;*/</span></li><li class="L4"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="typ">UserResponseConverter</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;</span><span class="kwd">implements</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">,</span><span class="pln">&nbsp;T</span><span class="pun">&gt;</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">private</span><span class="pln">&nbsp;</span><span class="typ">Type</span><span class="pln">&nbsp;type</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Gson</span><span class="pln">&nbsp;gson&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Gson</span><span class="pun">();</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">UserResponseConverter</span><span class="pun">(</span><span class="typ">Type</span><span class="pln">&nbsp;type</span><span class="pun">)</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">type&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;type</span><span class="pun">;</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;T&nbsp;convert</span><span class="pun">(</span><span class="typ">ResponseBody</span><span class="pln">&nbsp;responseBody</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="kwd">throws</span><span class="pln">&nbsp;</span><span class="typ">IOException</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;result&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;responseBody</span><span class="pun">.</span><span class="kwd">string</span><span class="pun">();</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">result</span><span class="pun">.</span><span class="pln">startsWith</span><span class="pun">(</span><span class="str">"["</span><span class="pun">))</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">T</span><span class="pun">)</span><span class="pln">&nbsp;parseUsers</span><span class="pun">(</span><span class="pln">result</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">else</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">T</span><span class="pun">)</span><span class="pln">&nbsp;parseUser</span><span class="pun">(</span><span class="pln">result</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">private</span><span class="pln">&nbsp;</span><span class="typ">User</span><span class="pln">&nbsp;parseUser</span><span class="pun">(</span><span class="typ">String</span><span class="pln">&nbsp;result</span><span class="pun">)</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">JSONObject</span><span class="pln">&nbsp;jsonObject&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">try</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jsonObject&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">JSONObject</span><span class="pun">(</span><span class="pln">result</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">User</span><span class="pln">&nbsp;u&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">User</span><span class="pun">();</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u</span><span class="pun">.</span><span class="pln">setUsername</span><span class="pun">(</span><span class="pln">jsonObject</span><span class="pun">.</span><span class="pln">getString</span><span class="pun">(</span><span class="str">"username"</span><span class="pun">));</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;u</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">catch</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">JSONException</span><span class="pln">&nbsp;e</span><span class="pun">)</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e</span><span class="pun">.</span><span class="pln">printStackTrace</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">;</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">private</span><span class="pln">&nbsp;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;parseUsers</span><span class="pun">(</span><span class="typ">String</span><span class="pln">&nbsp;result</span><span class="pun">)</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span class="pln">&nbsp;users&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">ArrayList</span><span class="pun">&lt;&gt;();</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">try</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">JSONArray</span><span class="pln">&nbsp;jsonArray&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">JSONArray</span><span class="pun">(</span><span class="pln">result</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">User</span><span class="pln">&nbsp;u&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">for</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="kwd">int</span><span class="pln">&nbsp;i&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">;</span><span class="pln">&nbsp;i&nbsp;</span><span class="pun">&lt;</span><span class="pln">&nbsp;jsonArray</span><span class="pun">.</span><span class="pln">length</span><span class="pun">();</span><span class="pln">&nbsp;i</span><span class="pun">++)</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">JSONObject</span><span class="pln">&nbsp;jsonObject&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;jsonArray</span><span class="pun">.</span><span class="pln">getJSONObject</span><span class="pun">(</span><span class="pln">i</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">User</span><span class="pun">();</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u</span><span class="pun">.</span><span class="pln">setUsername</span><span class="pun">(</span><span class="pln">jsonObject</span><span class="pun">.</span><span class="pln">getString</span><span class="pun">(</span><span class="str">"username"</span><span class="pun">));</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;users</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">u</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">catch</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">JSONException</span><span class="pln">&nbsp;e</span><span class="pun">)</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e</span><span class="pun">.</span><span class="pln">printStackTrace</span><span class="pun">();</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;users</span><span class="pun">;</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li></ol></pre><p>这里简单读取了一个属性，大家肯定能看懂，这样就能满足返回值是<code>Call&lt;List&lt;User&gt;&gt;</code>或者<code>Call&lt;User&gt;</code>.</p><p>这里郑重提醒：如果你针对特定的类型去写<code>Converter</code>，一定要在<code>UserConverterFactory#responseBodyConverter</code>中对类型进行检查，发现不能处理的类型<code>return null</code>，这样的话，可以交给后面的<code>Converter.Factory</code>处理，比如本例我们可以按照下列方式检查:</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="typ">UserConverterFactory</span><span class="pln">&nbsp;</span><span class="kwd">extends</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">.</span><span class="typ">Factory</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">&lt;</span><span class="typ">ResponseBody</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="pun">?&gt;</span><span class="pln">&nbsp;responseBodyConverter</span><span class="pun">(</span><span class="typ">Type</span><span class="pln">&nbsp;type</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Annotation</span><span class="pun">[]</span><span class="pln">&nbsp;annotations</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pln">&nbsp;retrofit</span><span class="pun">)</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="com">//根据type判断是否是自己能处理的类型，不能的话，return&nbsp;null&nbsp;,交给后面的Converter.Factory</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">type&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;</span><span class="typ">User</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">)</span><span class="com">//支持返回值是User</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">UserResponseConverter</span><span class="pun">(</span><span class="pln">type</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">type&nbsp;</span><span class="kwd">instanceof</span><span class="pln">&nbsp;</span><span class="typ">ParameterizedType</span><span class="pun">)</span><span class="com">//支持返回值是List&lt;User&gt;</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Type</span><span class="pln">&nbsp;rawType&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="pun">((</span><span class="typ">ParameterizedType</span><span class="pun">)</span><span class="pln">&nbsp;type</span><span class="pun">).</span><span class="pln">getRawType</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Type</span><span class="pln">&nbsp;actualType&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="pun">((</span><span class="typ">ParameterizedType</span><span class="pun">)</span><span class="pln">&nbsp;type</span><span class="pun">).</span><span class="pln">getActualTypeArguments</span><span class="pun">()[</span><span class="lit">0</span><span class="pun">];</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="pln">rawType&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;</span><span class="typ">List</span><span class="pun">.</span><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="pun">&amp;&amp;</span><span class="pln">&nbsp;actualType&nbsp;</span><span class="pun">==</span><span class="pln">&nbsp;</span><span class="typ">User</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">)</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">UserResponseConverter</span><span class="pun">(</span><span class="pln">type</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">null</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pun">}</span></li></ol></pre><p>好了，到这呢<code>responseBodyConverter</code>方法告一段落了，谨记就是将reponseBody-&gt;返回值返回中的实际类型，例如<code>Call&lt;User&gt;中的User</code>;还有对于该converter不能处理的类型一定要返回null。</p><h3 id="2requestbodyconverter">（2）requestBodyConverter</h3><p>ok，上面接口一大串方法呢，使用了我们的Converter之后，有个方法我们现在还是不支持的。</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="lit">@POST</span><span class="pun">(</span><span class="str">"add"</span><span class="pun">)</span></li><li class="L1"><span class="typ">Call</span><span class="pun">&lt;</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln">&nbsp;addUser</span><span class="pun">(</span><span class="lit">@Body</span><span class="pln">&nbsp;</span><span class="typ">User</span><span class="pln">&nbsp;user</span><span class="pun">);</span></li></ol></pre><p>ok，这个<code>@Body</code>需要用到这个方法，叫做<code>requestBodyConverter</code>，根据参数转化为<code>RequestBody</code>，下面看下我们如何提供支持。</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="typ">UserRequestBodyConverter</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln">&nbsp;</span><span class="kwd">implements</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pun">&gt;</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">private</span><span class="pln">&nbsp;</span><span class="typ">Gson</span><span class="pln">&nbsp;mGson&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Gson</span><span class="pun">();</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pln">&nbsp;convert</span><span class="pun">(</span><span class="pln">T&nbsp;value</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="kwd">throws</span><span class="pln">&nbsp;</span><span class="typ">IOException</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">String</span><span class="pln">&nbsp;</span><span class="kwd">string</span><span class="pln">&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;mGson</span><span class="pun">.</span><span class="pln">toJson</span><span class="pun">(</span><span class="pln">value</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="typ">MediaType</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="str">"application/json;&nbsp;charset=UTF-8"</span><span class="pun">),</span><span class="kwd">string</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L9"><span class="pun">}</span></li></ol></pre><p>然后在UserConverterFactory中复写requestBodyConverter方法，返回即可：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="typ">UserConverterFactory</span><span class="pln">&nbsp;</span><span class="kwd">extends</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">.</span><span class="typ">Factory</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="lit">@Override</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">public</span><span class="pln">&nbsp;</span><span class="typ">Converter</span><span class="pun">&lt;?,</span><span class="pln">&nbsp;</span><span class="typ">RequestBody</span><span class="pun">&gt;</span><span class="pln">&nbsp;requestBodyConverter</span><span class="pun">(</span><span class="typ">Type</span><span class="pln">&nbsp;type</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Annotation</span><span class="pun">[]</span><span class="pln">&nbsp;parameterAnnotations</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Annotation</span><span class="pun">[]</span><span class="pln">&nbsp;methodAnnotations</span><span class="pun">,</span><span class="pln">&nbsp;</span><span class="typ">Retrofit</span><span class="pln">&nbsp;retrofit</span><span class="pun">)</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">UserRequestBodyConverter</span><span class="pun">&lt;&gt;();</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L8"><span class="pun">}</span></li></ol></pre><p>这里偷了个懒，使用Gson将对象转化为json字符串了，如果你不喜欢使用框架，你可以选择拼接字符串，或者反射写一个支持任何对象的，反正就是对象-&gt;json字符串的转化。最后构造一个RequestBody返回即可。</p><p>ok,到这里，我相信如果你看的细致，自定义<code>Converter.Factory</code>是干嘛的，但是我还是要总结下：</p><ul class=" list-paddingleft-2"><li><p>responseBodyConverter 主要是对应<code>@Body</code>注解，完成ResponseBody到实际的返回类型的转化，这个类型对应<code>Call&lt;XXX&gt;</code>里面的泛型XXX，其实<code>@Part</code>等注解也会需要responseBodyConverter，只不过我们的参数类型都是<code>RequestBody</code>，由默认的converter处理了。</p></li><li><p>requestBodyConverter 完成对象到RequestBody的构造。</p></li><li><p>一定要注意，检查type如果不是自己能处理的类型，记得return null （因为可以添加多个，你不能处理return null ,还会去遍历后面的converter）.</p></li></ul><h2 id="七值得学习的api">七、值得学习的API</h2><p>其实一般情况下看源码呢，可以让我们更好的去使用这个库，当然在看的过程中如果发现了一些比较好的处理方式呢，是非常值得记录的。如果每次看别人的源码都能吸取一定的精华，比你单纯的去理解会好很多，因为你的记忆力再好，源码解析你也是会忘的，而你记录下来并能够使用的优越的代码，可能用久了就成为你的代码了。</p><p>我举个例子：比如retrofit2中判断当前运行的环境代码如下，如果下次你有这样的需求，你也可以这么写，甚至源码中根据不同的运行环境还提供了不同的<code>Executor</code>都很值得记录：</p><pre class="brush:js;toolbar:false prettyprint linenums prettyprinted" style="overflow: auto;"><ol class="linenums"><li class="L0"><span class="kwd">class</span><span class="pln">&nbsp;</span><span class="typ">Platform</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;</span><span class="kwd">private</span><span class="pln">&nbsp;</span><span class="kwd">static</span><span class="pln">&nbsp;</span><span class="kwd">final</span><span class="pln">&nbsp;</span><span class="typ">Platform</span><span class="pln">&nbsp;PLATFORM&nbsp;</span><span class="pun">=</span><span class="pln">&nbsp;findPlatform</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;</span><span class="kwd">static</span><span class="pln">&nbsp;</span><span class="typ">Platform</span><span class="pln">&nbsp;</span><span class="kwd">get</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;PLATFORM</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;</span><span class="kwd">private</span><span class="pln">&nbsp;</span><span class="kwd">static</span><span class="pln">&nbsp;</span><span class="typ">Platform</span><span class="pln">&nbsp;findPlatform</span><span class="pun">()</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">try</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Class</span><span class="pun">.</span><span class="pln">forName</span><span class="pun">(</span><span class="str">"android.os.Build"</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">if</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">Build</span><span class="pun">.</span><span class="pln">VERSION</span><span class="pun">.</span><span class="pln">SDK_INT&nbsp;</span><span class="pun">!=</span><span class="pln">&nbsp;</span><span class="lit">0</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Android</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">catch</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">ClassNotFoundException</span><span class="pln">&nbsp;ignored</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">try</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Class</span><span class="pun">.</span><span class="pln">forName</span><span class="pun">(</span><span class="str">"java.util.Optional"</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Java8</span><span class="pun">();</span></li><li class="L8"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">catch</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">ClassNotFoundException</span><span class="pln">&nbsp;ignored</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L9"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">try</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L1"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="typ">Class</span><span class="pun">.</span><span class="pln">forName</span><span class="pun">(</span><span class="str">"org.robovm.apple.foundation.NSObject"</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;IOS</span><span class="pun">();</span></li><li class="L3"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span><span class="pln">&nbsp;</span><span class="kwd">catch</span><span class="pln">&nbsp;</span><span class="pun">(</span><span class="typ">ClassNotFoundException</span><span class="pln">&nbsp;ignored</span><span class="pun">)</span><span class="pln">&nbsp;</span><span class="pun">{</span></li><li class="L4"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="kwd">return</span><span class="pln">&nbsp;</span><span class="kwd">new</span><span class="pln">&nbsp;</span><span class="typ">Platform</span><span class="pun">();</span></li><li class="L6"><span class="pln">&nbsp;&nbsp;</span><span class="pun">}</span></li></ol></pre><hr><p>ok，文章结束，最后打个广告，个人微信公众号目前关注大概9000人左右，无奈个人博文更新频率无法做到很好的为这么多人服务，所以本公众号欢迎大家投稿，如果你希望你的文章可以被更多人看到，直接将md、doc等格式的文章发我邮箱即可（623565791@qq.com），也可以加我好友，需要注明（投稿），谢谢。</p><p>文章要求：原创+你觉得通过文章你能学到一些有价值的东西。</p><p>福利：您的文章还可以发到csdn，简书等其他平台，但不能投稿至其他微信公众号了；更多人能够发现你的文章（好文我会帮你发送至我的各大群）+您的署名+您的原文链接，如果后期有打赏收益均归投稿人所有。</p><p>欢迎关注我的微博：&nbsp;<br style="box-sizing: border-box; color: rgb(85, 85, 85); font-family: &#39;microsoft yahei&#39;; font-size: 14px; line-height: 35px; white-space: normal; background-color: rgb(255, 255, 255);"><a href="http://weibo.com/u/3165018720">http://weibo.com/u/3165018720</a></p>
				</div>
			 
				<div class="pageActive clearfix" id="newdigg"><a href="javascript:void(0)" class="pageActive-item" onclick="postStow(4208)"><span><img src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/collection.png"></span>收藏(37)</a>
			<a href="javascript:void(0)" class="pageActive-item" onclick="postDigg(&#39;good&#39;,4208)"> <span><img src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/approve.png"></span>赞(18)</a>
			<a href="javascript:void(0)" class="pageActive-item" onclick="postDigg(&#39;bad&#39;,4208)"> <span><img src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/disapprove.png"></span>踩(1)</a>
          							
				</div>				
				<div id="collection-users-list" class="mgt60"><div class="sub-title">他们收藏了这篇文章</div><ul class="users-list clearfix"><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=wkwkwkwkwk"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index.php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=benio"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(1).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=homelajiang"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface.jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=%BB%D2%CC%AB%C0%C7"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(2).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=%BE%B2%D2%B9%D6%AE%BF%D5"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(3).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=qianpengzhen"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(4).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=chinapengwei"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(5).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=strange%DF%F7%BE%FD"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(1).jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=teasub"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(6).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=fcdream"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(7).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=lzcj4"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(8).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=MiraclesHed"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(9).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=kij"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(2).jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=805380422@qq.com"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface.png">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=shijiaowang"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(10).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=annaijin"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(3).jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=hyq2150"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(11).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=272655875"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(12).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=nie"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(13).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=%C7%EF%D2%E2%D4%AD"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(4).jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=seamless"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(5).jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=Chiang-Leoi"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(14).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=angcyo"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(6).jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=Pro47x"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(15).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=NC%D8%BCCoder.%B6%AB"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(16).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=speedy"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(7).jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=%B7%E7%B1%A9"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface.gif">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=Nice"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(8).jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=hearterfly"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(9).jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=xiabei56"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(17).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=Jerry%D8%BCxu"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(10).png">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=%C2%E4%B5%D8%B5%C4%C7%A6%B1%CA"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(18).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=Mear"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(11).jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=ZhuTH"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(19).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=allenli"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(12).jpg">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=Simple"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(20).php">  </a></li><li class="users-list-item"><a href="http://www.jcodecraeer.com/member/index.php?uid=TogtherYang"> <img class="avatar" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(21).php">  </a></li></ul>
				</div>			
				<div class="related_arc">
					<div class="sub-title">相关文章</div>
					<div class="rearc_list clearfix">
						<ul>   
						<li>
							 <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0915/3460.html" target="_blank">Retrofit 2.0：有史以来最大的改进</a>  <span class="pull-right"> 2016-04-25 </span></li>
<li>
							 <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/1111/3671.html" target="_blank">Retrofit的动态Endpoint</a>  <span class="pull-right"> 2015-11-11 </span></li>
<li>
							 <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0303/4029.html" target="_blank">Retrofit使用教程(一)</a>  <span class="pull-right"> 2016-03-03 </span></li>
<li>
							 <a href="http://www.jcodecraeer.com/plus/view.php?aid=7793" target="_blank">Retrofit动态传入地址</a>  <span class="pull-right"> 2017-04-07 </span></li>
<li>
							 <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2017/0601/8027.html" target="_blank">使用Retrofit 2.0上传图片文件</a>  <span class="pull-right"> 2017-06-01 </span></li>
<li>
							 <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0413/4140.html" target="_blank">带你学开源项目：Meizhi Android之RxJava &amp; Retrofit最佳实践</a>  <span class="pull-right"> 2016-04-13 </span></li>
<li>
							 <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2017/0710/8168.html" target="_blank">RxEasyHttp网络库简介（一）</a>  <span class="pull-right"> 2017-07-10 </span></li>
<li>
							 <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0519/4279.html" target="_blank">Retrofit--使用Retrofit时怎样去设置OKHttp</a>  <span class="pull-right"> 2016-05-19 </span></li>
<li>
							 <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2017/0721/8225.html" target="_blank">RxEasyHttp基于Retrofit2+RxJava2实现简单易用的网络请求框架（完整）</a>  <span class="pull-right"> 2017-07-21 </span></li>
<li>
							 <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/1125/6803.html" target="_blank">MVPArms MVP+Dagger+Retrofit+Rxjava快速集成框架</a>  <span class="pull-right"> 2016-11-25 </span></li>

						    
						</ul>
			   
					</div>  						
				</div>	
				<ul>				 
					<li style="margin-top:10px"><script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/fuckblok(2).php" language="javascript"></script></li>			
				</ul>										
            </div>				
             
            <div style="width:680px;"></div> 
			<div class="pre_next">
            	<div class="row"> 
                	 <div class="col-md-6">
					<div class="div_button">上一篇：<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4205.html">RenderScript :简单而快速的图像处理</a> <div>想用几行代码就能完成图片编辑吗？想不用复杂的OpenCL就能利用好你手机的GPU计算能力吗？那么，renderscript就是为你量身定做的。</div></div>
					</div>
					 <div class="col-md-6">
					<div class="div_button">下一篇：<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0505/4212.html">Dagger2深入理解</a> <div>最近，看到一些小伙伴想要入门Dagger2，加之最近刚经历了Dagger2的水深火热，在这里针对Dagger2中不同的注解方式，会生成怎样的代码，结合其生成的不同代码，来帮助大家做一些深入的理解。 概念 首先，Dagger2是一个DI的解决方案，跟之前接触过的Spring相比</div></div>
					</div>
                </div>
            </div>
            <div class="dede_comment_post">
				
<div class="comments_body">
	<form action="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#" method="post" name="feedback" onsubmit="return false;">
		<input type="hidden" name="dopost" value="send">
		<input type="hidden" name="comtype" value="comments">
		<input type="hidden" name="arcauthor" value="1 ">
		<input type="hidden" name="aid" value="4208">
		<input type="hidden" name="fid" id="feedbackfid" value="0">
		<div class="post_box clearfix">
            <textarea cols="60" name="msg" id="cm_content" rows="5" class="ipt-txt"></textarea>	
            <div class="post_act">
            	<button type="button clearfix" onclick="PostComment()">发表评论</button>
            </div>
		</div>
		
		
    </form>	
</div>


<!-- //评论表单区结束 -->
<!-- //评论内容区 -->
<a name="commettop"></a>

<div id="commetcontentNew">

</div>
<div id="commetcontent">		<div class="commnet-box">
		  <ul>
			<li class="clearfix"> 
				<div class="avatar">
					<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#" class="plpic"><img src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(22).php" height="40" width="40"></a>
				</div>
				<div class="post_body">
					<div class="post_header">
						<span class="title"><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#">网友1.202.132.99</a></span>
						<span class="bullet" aria-hidden="true">.</span>
						<span class="fl">2016-05-20</span>
					</div>
					<div class="post_content">
						看了两遍，看懂前半部分，后半部分修为不够，还的几遍。写的很好。					</div>
				   <div class="post_footer">
						<span class="fr">
							<span class="action-item" id="goodfb5235"> <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#goodfb5235" onclick="postBadGood(&#39;goodfb&#39;,5235);"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span></a>1 </span>
							<span class="action-item" id="badfb5235"> <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#badfb5235" onclick="postBadGood(&#39;badfb&#39;,5235);"><span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span></a>1 </span>
							<span class="quote action-item"><a href="javascript:ajaxFeedback(5235,5235,&quot;quote&quot;);"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span> 回复</a> </span>
						</span>
						
					</div>     
				</div>
				
			</li>
		  </ul>
		  <div id="ajaxfeedback_5235"></div>
		</div>
		<div class="commnet-box">
		  <ul>
			<li class="clearfix"> 
				<div class="avatar">
					<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#" class="plpic"><img src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(22).php" height="40" width="40"></a>
				</div>
				<div class="post_body">
					<div class="post_header">
						<span class="title"><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#">网友125.46.10.188</a></span>
						<span class="bullet" aria-hidden="true">.</span>
						<span class="fl">2016-05-12</span>
					</div>
					<div class="post_content">
						洪洋是真大神！&nbsp;&nbsp;后半段表示还要从新看一遍。					</div>
				   <div class="post_footer">
						<span class="fr">
							<span class="action-item" id="goodfb5153"> <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#goodfb5153" onclick="postBadGood(&#39;goodfb&#39;,5153);"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span></a>0 </span>
							<span class="action-item" id="badfb5153"> <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#badfb5153" onclick="postBadGood(&#39;badfb&#39;,5153);"><span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span></a>1 </span>
							<span class="quote action-item"><a href="javascript:ajaxFeedback(5153,5153,&quot;quote&quot;);"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span> 回复</a> </span>
						</span>
						
					</div>     
				</div>
				
			</li>
		  </ul>
		  <div id="ajaxfeedback_5153"></div>
		</div>
		<div class="commnet-box">
		  <ul>
			<li class="clearfix"> 
				<div class="avatar">
					<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#" class="plpic"><img src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/index(22).php" height="40" width="40"></a>
				</div>
				<div class="post_body">
					<div class="post_header">
						<span class="title"><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#">网友182.149.206.229</a></span>
						<span class="bullet" aria-hidden="true">.</span>
						<span class="fl">2016-05-05</span>
					</div>
					<div class="post_content">
						好文章已经收藏............					</div>
				   <div class="post_footer">
						<span class="fr">
							<span class="action-item" id="goodfb5099"> <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#goodfb5099" onclick="postBadGood(&#39;goodfb&#39;,5099);"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span></a>0 </span>
							<span class="action-item" id="badfb5099"> <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#badfb5099" onclick="postBadGood(&#39;badfb&#39;,5099);"><span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span></a>0 </span>
							<span class="quote action-item"><a href="javascript:ajaxFeedback(5099,5099,&quot;quote&quot;);"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span> 回复</a> </span>
						</span>
						
					</div>     
				</div>
				
			</li>
		  </ul>
		  <div id="ajaxfeedback_5099"></div>
		</div>
		<div class="commnet-box">
		  <ul>
			<li class="clearfix"> 
				<div class="avatar">
					<a href="http://www.jcodecraeer.com/member/index.php?uid=CastleDrv" class="plpic"><img src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/myface(13).jpg" height="40" width="40"></a>
				</div>
				<div class="post_body">
					<div class="post_header">
						<span class="title"><a href="http://www.jcodecraeer.com/member/index.php?uid=CastleDrv">CastleDrv</a></span>
						<span class="bullet" aria-hidden="true">.</span>
						<span class="fl">2016-05-04</span>
					</div>
					<div class="post_content">
						正在学Rxjava搭配Retrofit的使用。先Mark下					</div>
				   <div class="post_footer">
						<span class="fr">
							<span class="action-item" id="goodfb5091"> <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#goodfb5091" onclick="postBadGood(&#39;goodfb&#39;,5091);"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span></a>1 </span>
							<span class="action-item" id="badfb5091"> <a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0504/4208.html#badfb5091" onclick="postBadGood(&#39;badfb&#39;,5091);"><span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span></a>0 </span>
							<span class="quote action-item"><a href="javascript:ajaxFeedback(5091,5091,&quot;quote&quot;);"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span> 回复</a> </span>
						</span>
						
					</div>     
				</div>
				
			</li>
		  </ul>
		  <div id="ajaxfeedback_5091"></div>
		</div>
</div>
<!--
//由于评论载入时使用异步传输，因此必须在最后一步加载（DIGG和评论框须放在评论内容前面）
//如果一定需要提前的把myajax.SendGet改为myajax.SendGet2，但可能会引起页面阻滞
-->
<script language="javascript">
function LoadCommets(page)
{
		var taget_obj = document.getElementById('commetcontent');
		var waithtml = "<div style='line-height:50px'><img src='/images/loadinglit.gif' />评论加载中...</div>";
		var myajax = new MyAjax(taget_obj, true, true, '', 'x', waithtml);
		myajax.SendGet2("/plus/feedback_ajax.php?dopost=getlist&aid=4208&page="+page);
		DedeXHTTP = null;
}
function updatetag(){
	var tags = $DE("tags").value;
	var nfeedbacktype = 'feedback';
	var taget_obj = $DE('tag_response');
	var myajax = new MyAjax(taget_obj, false, true, '', '', "...");
	myajax.sendlang = 'gb2312';
	myajax.AddKeyN('dopost', 'send');
	myajax.AddKeyN('id', '4208');
	myajax.AddKeyN('tags', tags);
	myajax.SendPost2('/action/update_tags.php');	
}
function PostComment()
{
		var f = document.feedback;
		var msg = $DE("cm_content").value;
		var nface = '6';
		var nfeedbacktype = 'feedback';
		var nvalidate = '';
		var nnotuser = '';
		var nusername = '';
		var npwd = '';
		var taget_obj = $DE('commetcontentNew');
		var waithtml = "<div style='line-height:30px'><img src='/images/loadinglit.gif' />正在发送中...</div>";
		if(msg=='')
		{
			alert("评论内容不能为空！");
			return;
		}
		if(f.validate)
		{
			if(f.validate.value=='') {
				alert("请填写验证码！");
				return;
			}
			else {
				nvalidate = f.validate.value;
			}
		}
		if(msg.length > 500)
		{
			alert("你的评论是不是太长了？请填写500字以内的评论。");
			return;
		}
		if(f.feedbacktype) {
			for(var i=0; i < f.feedbacktype.length; i++)
				if(f.feedbacktype[i].checked) nfeedbacktype = f.feedbacktype[i].value;
		}
		/*
		if(f.face) {
			for(var j=0; j < f.face.length; j++)
				if(f.face[j].checked) nface = f.face[j].value;
		}
		*/

		
		var myajax = new MyAjax(taget_obj, false, true, '', '', waithtml);
		myajax.sendlang = 'gb2312';
		myajax.AddKeyN('dopost', 'send');
		myajax.AddKeyN('aid', '4208');
		myajax.AddKeyN('fid', f.fid.value);
		myajax.AddKeyN('face', nface);
		myajax.AddKeyN('feedbacktype', nfeedbacktype);
		myajax.AddKeyN('validate', nvalidate);
		myajax.AddKeyN('notuser', nnotuser);
		myajax.AddKeyN('username', nusername);
		myajax.AddKeyN('pwd', npwd);
		myajax.AddKeyN('msg', msg);
		myajax.AddKeyN('arcauthor', f.arcauthor.value);

		myajax.SendPost2('/plus/feedback_ajax.php');
		//msg = '';
		CKEDITOR.instances.msg.setData('');
		//taget_obj.removeAttribute('id');
		f.fid.value = 0;
		if(f.validate)
		{
			if($DE('validateimg')) $DE('validateimg').src = "/include/vdimgck.php?"+f.validate.value;
			f.validate.value = '';
		}
		
}
function quoteCommet(fid)
{
	    document.feedback.fid.value = fid;
}
  
function ajaxFeedback(aid, fid, type)
{
	var taget_obj = $DE('ajaxfeedback_'+fid);
	if(taget_obj.innerHTML == '')
	{
		var myajax = new MyAjax(taget_obj, true, true, '', 'x');
		myajax.SendGet2("/plus/feedback.php?aid="+aid+"&fid="+fid+"&action=quote&type=ajax");
		eval('var result = typeof CKEDITOR.instances.msg_'+fid);
		if(result != 'undefined')
		{
			// 删除实例
			eval('var edit = CKEDITOR.instances.msg_'+fid);
			CKEDITOR.remove(edit);
		}
		CKEDITOR.replace(document.getElementById('msg_'+fid) , CKEDITOR.instances.msg.config);
		scroll(0, taget_obj.offsetTop - 120);
		var formname = 'f = document.ajaxfeedback_'+fid;
		eval(formname);
		if(f.validate)
		{
			if($DE('vdimg_'+fid)) $DE('vdimg_'+fid).src = "/include/vdimgck.php?"+f.validate.value;
			f.validate.value = '';
		}
		
		DedeXHTTP = null;
	}else{
		taget_obj.innerHTML = '';
	}
}

function postBadGood(ftype,fid)
{
	var taget_obj = document.getElementById(ftype+fid);
	var saveid = GetCookie('badgoodid');
	if(saveid != null)
	{
		var saveids = saveid.split(',');
		var hasid = false;
		saveid = '';
		j = 1;
		for(i=saveids.length-1;i>=0;i--)
		{
			if(saveids[i]==fid && hasid) continue;
			else {
				if(saveids[i]==fid && !hasid) hasid = true;
				saveid += (saveid=='' ? saveids[i] : ','+saveids[i]);
				j++;
				if(j==10 && hasid) break;
				if(j==9 && !hasid) break;
			}
		}
		if(hasid) { alert('您刚才已表决过了喔！'); return false;}
		else saveid += ','+fid;
		SetCookie('badgoodid',saveid,1);
	}
	else
	{
		SetCookie('badgoodid',fid,1);
	}
	myajax = new MyAjax(taget_obj,false,false,'','','');
	myajax.SendGet2("/plus/feedback.php?aid="+fid+"&action="+ftype+"&fid="+fid);
}

function ajaxQuotePost(fid)
{
	var formname = 'f = document.ajaxfeedback_'+fid;
	eval(formname);
	//var f = document.formname;
	//var f = f[0];
	var nvalidate = '';
	var nnotuser = '';
	var nusername = '';
	var npwd = '';
	var taget_obj = $DE('commetcontentNew');
	var waithtml = "<div style='line-height:30px'><img src='/images/loadinglit.gif' />正在发送中...</div>";
	eval('var msg = $DE("msg_'+fid+'").value');
	if(f.validate)
	{
		if(f.validate.value=='') {
			alert("请填写验证码！");
			return;
		}
		else {
			nvalidate = f.validate.value;
		}
	}
	var myajax = new MyAjax(taget_obj, false, true, '', '', waithtml);
	

	
	myajax.sendlang = 'gb2312';
	myajax.AddKeyN('dopost', 'send');
	myajax.AddKeyN('aid', '4208');
	myajax.AddKeyN('fid', f.fid.value);
	myajax.AddKeyN('type', 'ajax');
	myajax.AddKeyN('comtype', f.comtype.value);
	myajax.AddKeyN('isconfirm','yes');
	
	myajax.AddKeyN('typeid', f.typeid.value);
	myajax.AddKeyN('quotemsg', f.quotemsg.value);
	myajax.AddKeyN('validate', nvalidate);
	myajax.AddKeyN('notuser', nnotuser);
	myajax.AddKeyN('username', nusername);
	myajax.AddKeyN('pwd', npwd);
	myajax.AddKeyN('msg', msg);
	myajax.SendPost2('/plus/feedback_ajax.php');
	//alert(f.quotemsg.value);
	if($DE('ajaxfeedback_'+fid).innerHTML != null)
	{
		$DE('ajaxfeedback_'+fid).innerHTML = '';
	}
	scroll(0, taget_obj.offsetTop);
}
LoadCommets(1);
</script>
<!-- //评论内容区结束 -->

 			</div>  
 
                                   
        </div>  
        <!-- end  of  content -->

        <div class="col-md-3">  
 
			<div class="sub-title">推荐文章</div>
			<ul class="sidearticle_c clearfix">                     
				<li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0227/4005.html" target="_blank">Android插件化原理解析――概要</a></li>
<li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2014/0813/1645.html" target="_blank">NumberProgressBar：一个简约性感的数字ProgressBar</a></li>
<li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2017/0523/7963.html" target="_blank">App开发架构指南（谷歌官方文档译文）</a></li>
<li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0306/2552.html" target="_blank">SQLBrite:一个响应式的数据查询框架</a></li>
<li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0429/4200.html" target="_blank">终于等到你Depth-LIB-Android</a></li>
<li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0104/2259.html" target="_blank">将Eclipse代码导入到Android Studio的两种方式</a></li>

			</ul>				 
		            

			<div class="sub-title">赞助商</div>
			 
                                                               
            <div style="height: 505px;"></div><div id="floatbox" style="top: 0px; position: fixed; width: 263px;">  
				<script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/fuckblok(3).php" language="javascript"></script><script async="" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/adsbygoogle.js.下载"></script>
<!-- 250x250 -->
<ins class="adsbygoogle" style="display:inline-block;width:250px;height:250px" data-ad-client="ca-pub-8583773779396897" data-ad-slot="3660827512" data-adsbygoogle-status="done"><ins id="aswift_1_expand" style="display:inline-table;border:none;height:250px;margin:0;padding:0;position:relative;visibility:visible;width:250px;background-color:transparent;"><ins id="aswift_1_anchor" style="display:block;border:none;height:250px;margin:0;padding:0;position:relative;visibility:visible;width:250px;background-color:transparent;"><iframe width="250" height="250" frameborder="0" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_1" name="aswift_1" style="left:0;position:absolute;top:0;width:250px;height:250px;" src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/saved_resource(2).html"></iframe></ins></ins></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>	
				<script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/fuckblok(4).php" language="javascript"></script><a href="https://www.trustauth.cn/marketing/freessl.html?utm_source=jcodecraeer&amp;utm_medium=social&amp;utm_campaign=freesslnew&amp;utm_content=freesslnew" target="_blank"><img src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/泡在网上的日子250x250.png"></a>
         	</div>
            
        </div>        
    
        <div style="clear:both;"></div>
	</div> 	
</div> 
<script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/jcodecraeer.js.下载"></script>
<!-- 返回顶部 -->
<div id="gotop" style="display: block;"></div>

<script type="text/javascript">
	backTop=function (btnId){
		var btn=document.getElementById(btnId);
		var d=document.documentElement;
		var b=document.body;
		window.onscroll=set;
		btn.onclick=function (){
			btn.style.display="none";
			window.onscroll=null;
			this.timer=setInterval(function(){
				d.scrollTop-=Math.ceil((d.scrollTop+b.scrollTop)*0.1);
				b.scrollTop-=Math.ceil((d.scrollTop+b.scrollTop)*0.1);
				if((d.scrollTop+b.scrollTop)==0) clearInterval(btn.timer,window.onscroll=set);
			},10);
		};
		function set(){
			btn.style.display=(d.scrollTop+b.scrollTop>100)?'block':"none";
		}
	};
	backTop('gotop');
	
	(new SidebarFollow()).init({
		element: jQuery('#floatbox'),
		distanceToTop: 0
	});	
	
</script>


<!-- 返回顶部END -->
<style>
#gotop {
	background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEMAAAANAgMAAACP9jv8AAAACVBMVEX///////8AAACO9MPsAAAAAXRSTlMAQObYZgAAAGhJREFUeF49zsEJwCAMBdBvoRfvWaJTOEIPZp+O4lEyZcn/RIl+SMJDAG2gTlfc7+k8H8Pm6cRiuFfjip3RphXUV4ghJIaQjVZQoCfkLDI7C7kgiAuRDK+YvJwLQnBPhovRw7ER5of3DyPbFp8RB9axAAAAAElFTkSuQmCC") no-repeat scroll 18px 21px #000000;
    bottom: 200px;
    cursor: pointer;
    display: block;
    height: 60px;
    opacity: 0.5;
    overflow: hidden;
    transition: opacity 0.3s ease-in 0s, opacity 0.3s ease-out 0s;
     right: 10px;
    position: fixed;
    top: auto;
    width: 60px;
    z-index: 999;
}
</style>
<div class="footer">
	<div class="container">	
		<div class="row clearfix">
			<div class="col-md-12">
				<div class="copyright z">
					<p>Copyright  2011 - 2016 jcodecraeer.com All Rights Reversed.</p>
					<p>蜀ICP备12021840号-1</p>
					<p>本站文章用于学习交流</p>
				</div>
				<div class="footer-nav y">
					<ul class="clearfix">
						<li><script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/fuckblok(5).php" language="javascript"></script>本站CDN／存储服务由又拍云<a href="https://console.upyun.com/register/?invite=H1NEyK4L-&amp;utm_source=Referral&amp;utm_medium=jcode&amp;utm_content=dex"><img src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/又拍云 LOGO (1).png" width="150"></a>提供</li>
					</ul>					
					<ul class="clearfix">
						<li><a href="http://weibo.com/u/2711441293" target="_blank">新浪微博</a></li>
						<li>qq群一161644793</li>
						<li>qq群二98711210</li> 
					</ul>
					<ul class="clearfix">
						<li><a href="http://www.jcodecraeer.com/sitemap/" target="_blank">网站地图</a></li>	
						<li>				
						<script type="text/javascript">
						var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
						document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F2f2ac530df20294f718580cea710780e' type='text/javascript'%3E%3C/script%3E"));
						</script><script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/h.js.下载" type="text/javascript"></script><a href="http://tongji.baidu.com/hm-web/welcome/ico?s=2f2ac530df20294f718580cea710780e" target="_blank">网站统计</a> 
						</li>	 
					</ul>			
				</div>
			</div>
		</div>
	</div>	
</div>

<script src="./Retrofit2 完全解析 探索与okhttp之间的关系 - 泡在网上的日子_files/prettify.js.下载"></script>


</body></html>